<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KCP Map For Sales Management (Active Customer & Leads)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
    #map { position: fixed; inset: 0; height: 100vh; width: 100vw; }
    .leaflet-tooltip.my {
      background:#111827; color:#fff; border:none;
      border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,.2);
      padding:6px 8px;
    }
    .badge { padding:2px 8px; border-radius:999px; font-size:12px; font-weight:600; }
    .custom-scrollbar::-webkit-scrollbar { width: 4px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }

    /* Styles ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Multi Select */
    .ms-btn {
      width: 100%; text-align: left; background: white; border: 1px solid #d1d5db;
      border-radius: 0.5rem; padding: 6px 10px; font-size: 0.875rem; 
      display: flex; justify-content: space-between; align-items: center; cursor: pointer;
    }
    .ms-dropdown {
      position: absolute; top: 100%; left: 0; right: 0; 
      background: white; border: 1px solid #e5e7eb; border-radius: 0.5rem;
      margin-top: 4px; max-height: 200px; overflow-y: auto; z-index: 50;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); display: none;
    }
    .ms-dropdown.show { display: block; }
    .ms-item { display: flex; align-items: center; padding: 6px 10px; cursor: pointer; font-size: 0.8rem; }
    .ms-item:hover { background-color: #f3f4f6; }
    .ms-item input { margin-right: 8px; }
    
    /* Styles ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏°‡∏∏‡∏î‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç (Route Sequence) */
    .clear-icon { background: transparent; border: none; }
  </style>
</head>
<body class="bg-gray-50">

  <div id="panel" class="fixed z-[999] top-3 left-3 w-[360px] max-w-[92vw] bg-white/95 backdrop-blur border border-gray-200 rounded-2xl shadow-xl max-h-[90vh] overflow-y-auto custom-scrollbar">
    <div class="p-4 border-b">
      <h1 class="text-xl font-bold text-gray-900">KCP Map For Sales Management</h1>
      <p class="text-xs text-gray-500">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (Multi-Select)</p>
      <p class="text-xs text-gray-500">‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î 15 ‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå 69</p>
    </div>
    <div class="p-4 flex flex-col gap-3">
      
      <div class="bg-blue-50 border border-blue-200 rounded-xl p-3 shadow-sm relative overflow-hidden">
        <div class="absolute right-0 top-0 w-16 h-16 bg-blue-100 rounded-bl-full opacity-50 pointer-events-none"></div>
        <label class="text-sm font-bold text-blue-900 mb-1 flex items-center gap-1">
          üöö ‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏£‡∏ñ (Routing)
        </label>
        <p class="text-[10px] text-blue-700 mb-2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏£‡∏á‡∏à‡∏≤‡∏Å Sheet: "‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á"</p>
        
        <div class="flex items-center gap-2 mt-1">
          <label class="inline-flex items-center gap-1 text-[11px] font-semibold text-gray-700 cursor-pointer">
            <input type="checkbox" id="toggleRoutes" class="rounded accent-blue-600" checked />
            ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏ß‡∏¥‡πà‡∏á‡∏£‡∏ñ
          </label>
        </div>
        <div id="routeLegend" class="flex gap-1 flex-wrap mt-2"></div>
      </div>

      <div class="grid grid-cols-2 gap-2 mt-1">
        <div class="relative">
          <label class="text-xs text-gray-600 mb-1 block">‡∏™‡∏≤‡∏Ç‡∏≤ (Branch)</label>
          <div id="branchFilterWrap" class="relative"></div>
        </div>
        <div class="relative">
          <label class="text-xs text-gray-600 mb-1 block">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</label>
          <div id="managerFilterWrap" class="relative"></div>
        </div>
        <div class="relative">
          <label class="text-xs text-gray-600 mb-1 block">‡∏£‡∏ñ‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå (Truck)</label>
          <div id="truckFilterWrap" class="relative"></div>
        </div>
        <div class="relative">
          <label class="text-xs text-gray-600 mb-1 block">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label>
          <div id="statusFilterWrap" class="relative"></div>
        </div>

        <div class="col-span-2 text-xs text-gray-600 mt-2">
          ‡∏£‡∏±‡∏®‡∏°‡∏µ 100 ‡∏Å‡∏°. ‡∏£‡∏≠‡∏ö‡∏™‡∏≤‡∏Ç‡∏≤ (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏™‡∏≤‡∏Ç‡∏≤)
          <div class="mt-1 flex flex-wrap gap-2">
            <label class="inline-flex items-center gap-1 cursor-pointer">
              <input type="checkbox" class="radiusChoice rounded accent-gray-900" value="ST" />
              <span class="text-xs">ST</span>
            </label>
            <label class="inline-flex items-center gap-1 cursor-pointer">
              <input type="checkbox" class="radiusChoice rounded accent-gray-900" value="KN" />
              <span class="text-xs">KN</span>
            </label>
            <label class="inline-flex items-center gap-1 cursor-pointer">
              <input type="checkbox" class="radiusChoice rounded accent-gray-900" value="MUK" />
              <span class="text-xs">MUK</span>
            </label>
            <label class="inline-flex items-center gap-1 cursor-pointer">
              <input type="checkbox" class="radiusChoice rounded accent-gray-900" value="WNN" />
              <span class="text-xs">WNN</span>
            </label>
          </div>
        </div>
      </div>

      <div class="flex items-center gap-3 mt-1">
        <label class="inline-flex items-center gap-2 text-sm cursor-pointer">
          <input id="toggleLeads" type="checkbox" class="rounded accent-gray-900" checked /> ‡πÅ‡∏™‡∏î‡∏á Leads
        </label>
        <label class="inline-flex items-center gap-2 text-sm cursor-pointer">
          <input id="toggleNearest" type="checkbox" class="rounded accent-gray-900" checked /> ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏ñ‡πÉ‡∏Å‡∏•‡πâ‡∏™‡∏∏‡∏î
        </label>
      </div>

      <div class="flex gap-2 flex-wrap mt-2">
        <button id="btnRefresh" class="px-3 py-2 text-sm rounded-lg bg-gray-900 text-white hover:bg-gray-800 transition">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
        <button id="btnReset" class="px-3 py-2 text-sm rounded-lg border hover:bg-gray-50 transition">‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</button>
        <button id="btnExport" class="px-3 py-2 text-sm rounded-lg bg-emerald-600 text-white hover:bg-emerald-700 transition">Export</button>
      </div>

      <div class="rounded-xl border bg-white p-3 mt-2 shadow-sm">
        <div class="text-xs text-gray-500 mb-1">‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</div>
        <div id="summary" class="text-sm grid grid-cols-2 gap-x-3 gap-y-1">
          <div>Customers:</div><div id="sumCustomers" class="font-semibold">-</div>
          <div>Leads:</div><div id="sumLeads" class="font-semibold">-</div>
          
          <div class="text-emerald-600">Active:</div>
          <div id="sumActive" class="font-semibold text-emerald-600">-</div>
          
          <div class="text-amber-600">Risky:</div>
          <div id="sumRisky" class="font-semibold text-amber-600">-</div>
          
          <div class="text-red-600">Lost:</div>
          <div id="sumLost" class="font-semibold text-red-600">-</div>
          
          <div class="text-blue-600">Winback:</div>
          <div id="sumWinback" class="font-semibold text-blue-600">-</div>
          
          <div class="text-gray-400">Dormant:</div>
          <div id="sumDormant" class="font-semibold text-gray-400">-</div>
        </div>
        <div id="errorBox" class="text-xs text-red-600 mt-2 hidden"></div>
      </div>
    </div>
  </div>
  
  <div id="map"></div>

<script>
    // ==========================================
    // 1. CONFIGURATION & CONSTANTS
    // ==========================================
    const SHEET_ID = "1Vo4d5_bJPzqHjQDABLTcOrPhqx1tUJ3P11W3cRjfmAo";
    // ‡πÄ‡∏û‡∏¥‡πà‡∏° Sheet "‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á" ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    const SHEETS = { customers: "Customers", leads: "leads", trucks: "Trucks", settings: "Settings", routes: "‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á" }; 

    const ALLOWED_SALES_NAMES = [
      "‡∏ä‡∏≤‡∏ç‡∏ä‡∏±‡∏¢ (‡∏ï‡πâ‡∏≠‡∏°)", "‡∏ì‡∏±‡∏è‡∏ê‡∏†‡∏£‡∏ì‡πå (‡∏≠‡πâ‡∏≠‡∏°)", "‡∏ò‡∏µ‡∏£‡∏∞‡∏û‡∏±‡∏ô‡∏ò‡πå (‡∏à‡∏∏‡πà‡∏ô)", "‡∏ö‡∏∏‡∏ç‡∏¢‡πå‡∏°‡∏ô‡∏±‡∏™ (‡∏Ñ‡∏∏‡∏ì‡∏ù‡∏ô)", "‡∏õ‡∏¥‡∏¢‡∏ò‡∏¥‡∏î‡∏≤ (‡∏≠‡∏∏‡πâ‡∏¢)" , "‡∏™‡∏∏‡∏†‡∏≤‡∏†‡∏¥‡πÑ‡∏• (‡πÑ‡∏Å‡πà)"
    ];

    const BRANCH_RADIUS_CENTERS = {
      ST:  { lat: 16.381029272179042, lng: 103.34881852164082 },
      KN:  { lat: 16.71600409911031,  lng: 103.08205194412724 },
      MUK: { lat: 16.43599207530131,  lng: 104.61612804232725 },
      WNN: { lat: 17.6293190999291,   lng: 103.7676571040772 }
    };
    const RADIUS_FILTER_KM = 100;
    const RADIUS_COLORS = { ST: { stroke: "#3b82f6", fill: "#3b82f6" }, KN: { stroke: "#22c55e", fill: "#22c55e" }, MUK: { stroke: "#a855f7", fill: "#a855f7" }, WNN: { stroke: "#ef4444", fill: "#ef4444" } };

    // ==========================================
    // 2. STATE MANAGEMENT & GLOBALS
    // ==========================================
    let activeFilters = { branch: [], manager: [], truck: [], status: [] };
    let data = { customers: [], leads: [], trucks: [], settings: [], routes: [] };
    let truckColorMap = {};

    const map = L.map('map');
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
    const layerCustomers = L.layerGroup().addTo(map),
          layerLeads = L.layerGroup().addTo(map),
          layerTrucks = L.layerGroup().addTo(map),
          layerLines = L.layerGroup().addTo(map),
          layerRadius = L.layerGroup().addTo(map),
          layerRoutes = L.featureGroup().addTo(map);

    // ==========================================
    // 3. UTILITY FUNCTIONS
    // ==========================================
    function showError(msg){
      console.error(msg);
      const box = document.getElementById('errorBox');
      if(box) { box.textContent = msg; box.classList.remove('hidden'); }
    }

    function norm(v){ return (v==null?'':String(v)).trim(); }
    const normId = (id) => (id || "").toString().trim().toLowerCase();
    const normHex = (c) => { if (!c) return ""; const raw = String(c).trim().replace(/^#/, ""); return /^[0-9A-Fa-f]{6}$/.test(raw) ? "#" + raw.toUpperCase() : ""; };
    const uniqueSorted = (arr) => [...new Set(arr.filter(Boolean))].sort((a,b)=>a.localeCompare(b,'th'));

    async function fetchSheet(sheetName, sheetId = SHEET_ID) {
      const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}&tq=`;
      const res = await fetch(url, { cache: "no-store" });
      const text = await res.text();
      const json = JSON.parse(text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1));
      const cols = json.table.cols.map(c => c.label || c.id);
      const rows = json.table.rows.map(r => (r.c || []).map(c => c ? (c.f ?? c.v ?? "") : ""));
      return rows.map(r => Object.fromEntries(r.map((v,i) => [cols[i] || `col${i+1}`, v])));
    }

    function getTruckColor(id) { return truckColorMap[normId(id)] || ""; }
    function getOwnerGroup(rawName) { const n = norm(rawName); if(!n) return ""; return ALLOWED_SALES_NAMES.includes(n) ? n : "‡∏≠‡∏∑‡πà‡∏ô‡πÜ"; }

    function mapStatusTH(raw){
      if(raw==null) return "";
      const sl = String(raw).trim().toLowerCase();
      if (sl === 'active' || sl === '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ active') return '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ Active';
      if (sl === 'risky to lost') return '‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏´‡∏≤‡∏¢';
      if (sl === 'lost customer') return '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏´‡∏≤‡∏¢';
      if (sl === 'winback/new customer' || sl === 'winback' || sl === 'new customer' || sl === 'new') return '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤/‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà';
      if (sl === 'dormant >60' || sl === 'dormant' || sl === 'deep lost' || sl === 'lost >60') return '‡∏´‡∏≤‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô 60 ‡∏ß‡∏±‡∏ô';
      return String(raw).trim();
    }

    // ==========================================
    // 4. MULTI-SELECT LOGIC
    // ==========================================
    function createMultiSelect(wrapperId, options, filterKey) {
      const wrapper = document.getElementById(wrapperId);
      if(!wrapper) return;
      wrapper.innerHTML = ''; 
      const btn = document.createElement('div');
      btn.className = 'ms-btn';
      btn.innerHTML = `<span class="truncate text-gray-500">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span> <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>`;
      const dropdown = document.createElement('div');
      dropdown.className = 'ms-dropdown custom-scrollbar';

      options.forEach(opt => {
        const val = opt.value || opt; const txt = opt.label || opt;
        const item = document.createElement('label'); item.className = 'ms-item';
        const chk = document.createElement('input'); chk.type = 'checkbox'; chk.value = val; chk.className = 'rounded accent-gray-900';
        if(activeFilters[filterKey].includes(val)) chk.checked = true;
        chk.addEventListener('change', () => { updateSelected(filterKey, wrapper, btn); render(); });
        item.appendChild(chk); item.appendChild(document.createTextNode(" " + txt)); dropdown.appendChild(item);
      });
      wrapper.appendChild(btn); wrapper.appendChild(dropdown);
      btn.addEventListener('click', (e) => { e.stopPropagation(); document.querySelectorAll('.ms-dropdown').forEach(d => { if(d !== dropdown) d.classList.remove('show'); }); dropdown.classList.toggle('show'); });
      updateSelected(filterKey, wrapper, btn);
    }

    function updateSelected(key, wrapper, btn) {
      const chks = wrapper.querySelectorAll('input[type="checkbox"]:checked');
      const values = Array.from(chks).map(c => c.value);
      activeFilters[key] = values;
      const span = btn.querySelector('span');
      if(values.length === 0) { span.textContent = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'; span.classList.add('text-gray-500'); span.classList.remove('text-gray-900');
      } else { span.textContent = `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ${values.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`; span.classList.remove('text-gray-500'); span.classList.add('text-gray-900'); }
    }
    document.addEventListener('click', () => { document.querySelectorAll('.ms-dropdown').forEach(d => d.classList.remove('show')); });

    // ==========================================
    // 5. MAP LOGIC & RENDERING
    // ==========================================
    const haversineKm=(a,b,c,d)=>{
      const R=6371,toRad=x=>x*Math.PI/180; const dLat=toRad(c-a),dLon=toRad(d-b);
      const h=Math.sin(dLat/2)**2+Math.cos(toRad(a))*Math.cos(toRad(c))*Math.sin(dLon/2)**2; return 2*R*Math.asin(Math.sqrt(h));
    };
    const gmapsUrl = (lat,lng) => `http://googleusercontent.com/maps.google.com/maps?q=${encodeURIComponent(lat+","+lng)}`;
    function makePinIcon(colorHex){
      const c = (colorHex||'#EF4444').replace('#','');
      const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="26" height="40" viewBox="0 0 26 40"><defs><filter id="shadow" x="-20%" y="-10%" width="140%" height="140%"><feGaussianBlur in="SourceAlpha" stdDeviation="1.5"/><feOffset dx="0" dy="1" result="o"/><feMerge><feMergeNode in="o"/><feMergeNode in="SourceGraphic"/></feMerge></filter></defs><path filter="url(#shadow)" d="M13 0C6.373 0 1 5.373 1 12c0 8.25 12 27 12 27s12-18.75 12-27C25 5.373 19.627 0 13 0z" fill="#${c}" stroke="#7a7a7a" stroke-width="0.6"/><circle cx="13" cy="12" r="5" fill="#fff"/></svg>`;
      return L.icon({ iconUrl: 'data:image/svg+xml;utf8,' + encodeURIComponent(svg), iconSize: [18,28], iconAnchor: [9,28], popupAnchor: [0,-24], tooltipAnchor: [0,-24] });
    }
    function leadPinColor(statusText){ return (String(statusText||'').trim() === '‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢') ? '#308320' : '#EF4444'; }

    const FIELD_LABELS = { customer_id: "‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤", customer_name: "‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤", _statusTH: "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤", branch: "‡∏™‡∏≤‡∏Ç‡∏≤", truck_id: "‡∏£‡∏ñ", person_incharge: "‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö", lastest_sales: "‡∏ö‡∏¥‡∏•‡∏Ç‡∏≤‡∏¢‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î", notes: "‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏", latitude: "Latitude", longitude: "Longtitude", lead_id: "‡∏£‡∏´‡∏±‡∏™ Lead", leads_name: "‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏µ‡∏î", status: "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Lead", saler: "‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢", province: "‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î", district: "‡∏≠‡∏≥‡πÄ‡∏†‡∏≠", nearest_truck_id: "‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î" };

    function buildRowsHtml(obj, fields, isDark = true){
      const labelColor = isDark ? "text-slate-300" : "text-gray-500"; const valueColor = isDark ? "text-white" : "text-gray-900";
      return fields.filter(k => obj[k] !== undefined && obj[k] !== null && String(obj[k]).trim() !== "").map(k => `<tr><td class="pr-2 ${labelColor} whitespace-nowrap">${FIELD_LABELS[k] || k}</td><td class="font-semibold ${valueColor}">${obj[k]}</td></tr>`).join('');
    }
    function tooltipHtml(obj,type){
      const fields = (type==='customer') ? ['customer_id','customer_name','lastest_sales','_statusTH','branch','truck_id','person_incharge','notes'] : ['leads_name','status','province','district','nearest_truck_id','saler','branch','notes'];
      const badge= type==='customer' ? `<span class="badge" style="background:${getTruckColor(obj.truck_id)||'#16a34a'};color:white">${obj._statusTH||''}</span>` : `<span class="badge" style="background:#2563eb;color:white">LEAD</span>`;
      return `<div class="text-sm"><div class="mb-1 font-bold">${obj.customer_name||obj.leads_name||obj.truck_id} ${badge}</div><table class="text-xs">${buildRowsHtml(obj, fields, true)}</table></div>`;
    }
    function popupHtml(obj,type){
      const lat = parseFloat(obj.latitude||obj.lat||obj.lattitude); const lng = parseFloat(obj.longitude||obj.lng||obj.longtitude||obj.lon);
      const fields = (type==='customer') ? ['customer_id','customer_name','lastest_sales','_statusTH','branch','truck_id','person_incharge','notes'] : ['leads_name','status','province','district','nearest_truck_id','saler','branch','notes'];
      const gmBtn = (isFinite(lat)&&isFinite(lng)) ? `<a href="${gmapsUrl(lat,lng)}" target="_blank" rel="noopener" class="mt-2 inline-block text-xs font-semibold text-blue-600 underline">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô Google Maps</a>`:'';
      return `<div class="text-sm"><div class="mb-1 font-bold text-gray-900">${obj.customer_name||obj.leads_name||obj.truck_id}</div><table class="text-xs">${buildRowsHtml(obj, fields, false)}</table>${gmBtn}</div>`;
    }
    function getSelectedRadiusBranches(){ return Array.from(document.querySelectorAll('.radiusChoice')).filter(ch => ch.checked).map(ch => ch.value).filter(v => !!BRANCH_RADIUS_CENTERS[v]); }

    function passFilters(item){
      if(activeFilters.branch.length > 0 && !activeFilters.branch.includes(item.branch || '')) return false;
      if(activeFilters.manager.length > 0) { const groupName = getOwnerGroup(item.person_incharge || item.saller); if(!activeFilters.manager.includes(groupName)) return false; }
      if(activeFilters.truck.length > 0) { const tid = item.truck_id || item.nearest_truck_id || ''; if(!activeFilters.truck.includes(tid)) return false; }
      if(activeFilters.status.length > 0) { const itemStatus = item._statusTH || ""; if(!activeFilters.status.includes(itemStatus)) return false; }
      const selectedBranches = getSelectedRadiusBranches();
      if(selectedBranches.length){
        const lat = parseFloat(item.latitude||item.lat||item.lattitude); const lng = parseFloat(item.longitude||item.lng||item.longtitude||item.lon);
        if(!isFinite(lat) || !isFinite(lng)) return false;
        let insideAny = false;
        for(const code of selectedBranches){ const center = BRANCH_RADIUS_CENTERS[code]; if(haversineKm(center.lat, center.lng, lat, lng) <= RADIUS_FILTER_KM){ insideAny = true; break; } }
        if(!insideAny) return false;
      }
      return true;
    }

   function setSummary({customers, leads}){
      document.getElementById('sumCustomers').textContent = customers.length;
      document.getElementById('sumLeads').textContent = leads.length;
      const count = (st) => customers.filter(c => (c._statusTH||'') === st).length;
      document.getElementById('sumActive').textContent = count('‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ Active');
      document.getElementById('sumRisky').textContent  = count('‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏´‡∏≤‡∏¢');
      document.getElementById('sumLost').textContent   = count('‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏´‡∏≤‡∏¢');
      document.getElementById('sumWinback').textContent = count('‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤/‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà');
      document.getElementById('sumDormant').textContent = count('‡∏´‡∏≤‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô 60 ‡∏ß‡∏±‡∏ô');
    }

    // ==========================================
    // 6. ROUTE DRAWING LOGIC (‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ data.routes)
    // ==========================================
    function drawRoutes() {
        layerRoutes.clearLayers();
        document.getElementById('routeLegend').innerHTML = '';
        
        // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏≤ (Checkbox) ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if (!document.getElementById('toggleRoutes').checked || !data.routes || data.routes.length === 0) return;

        let trips = {};
        
        // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏î‡∏∂‡∏á‡∏°‡∏≤‡∏à‡∏≤‡∏Å Google Sheet
        const getVal = (row, keys) => {
            const lowerKeys = keys.map(k => k.toLowerCase());
            for (let [k, v] of Object.entries(row)) {
                if (lowerKeys.includes(k.toLowerCase())) return v;
            }
            return null;
        };

        data.routes.forEach(d => {
            let tripId = getVal(d, ['‡∏ó‡∏£‡∏¥‡∏õ', 'Trip', 'trip', 'col1']);
            if(!tripId || String(tripId).trim() === '') return;
            
            if(!trips[tripId]) trips[tripId] = [];
            trips[tripId].push(d);
        });

        // ‡∏™‡∏µ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏£‡∏≠‡∏ö‡∏ß‡∏¥‡πà‡∏á
        const colors = ['#3b82f6', '#f59e0b', '#10b981', '#ef4444', '#8b5cf6', '#ec4899'];
        let colorIdx = 0;
        
        // ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏Ñ‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (MT-51 / MUK)
        const depotLat = 16.435979721332192;
        const depotLng = 104.61597521404217;

        // ‡∏ß‡∏≤‡∏î‡∏´‡∏°‡∏∏‡∏î‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        if (Object.keys(trips).length > 0) {
            L.circleMarker([depotLat, depotLng], {radius: 10, color: '#111827', fillColor: '#fff', fillOpacity: 1, weight: 4})
             .bindTooltip(`<b>‡∏Ñ‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°/‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î (MT-51)</b>`, {className: 'my', permanent: true, direction: 'right'})
             .addTo(layerRoutes);
        }

        Object.keys(trips).forEach(tripId => {
            let color = colors[colorIdx % colors.length];
            colorIdx++;

            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á
            let stops = trips[tripId].sort((a,b) => {
                let seqA = parseInt(getVal(a, ['‡∏•‡∏≥‡∏î‡∏±‡∏ö (‡∏ï‡∏≤‡∏°‡∏ó‡∏£‡∏¥‡∏õ)', 'Sequence', '‡∏•‡∏≥‡∏î‡∏±‡∏ö', 'col2']) || 0);
                let seqB = parseInt(getVal(b, ['‡∏•‡∏≥‡∏î‡∏±‡∏ö (‡∏ï‡∏≤‡∏°‡∏ó‡∏£‡∏¥‡∏õ)', 'Sequence', '‡∏•‡∏≥‡∏î‡∏±‡∏ö', 'col2']) || 0);
                return seqA - seqB;
            });

            let latlngs = [[depotLat, depotLng]];

            stops.forEach(stop => {
                let lat = parseFloat(getVal(stop, ['Latitude', 'latitude', 'lat', 'Lat', 'col7']));
                let lng = parseFloat(getVal(stop, ['Longitude', 'longitude', 'lon', 'Lng', 'col8']));
                
                if(isFinite(lat) && isFinite(lng)) {
                    latlngs.push([lat, lng]);

                    let seq = getVal(stop, ['‡∏•‡∏≥‡∏î‡∏±‡∏ö (‡∏ï‡∏≤‡∏°‡∏ó‡∏£‡∏¥‡∏õ)', 'Sequence', '‡∏•‡∏≥‡∏î‡∏±‡∏ö', 'col2']) || '-';
                    let shopName = getVal(stop, ['‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô', 'Customer Name', 'leads_name', 'col4']) || '-';
                    let g95 = getVal(stop, ['GAS95 (‡∏•‡∏¥‡∏ï‡∏£)', 'GAS95', 'GAS95 (L)', 'col9']) || 0;
                    let b7 = getVal(stop, ['Diesel B7 (‡∏•‡∏¥‡∏ï‡∏£)', 'Deisel B7', 'Diesel B7 (L)', 'col10']) || 0;

                    let icon = L.divIcon({
                        className: 'clear-icon',
                        html: `<div style="background-color:${color}; color:white; border-radius:50%; width:24px; height:24px; display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:11px; border:2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.4);">${seq}</div>`,
                        iconSize: [24, 24],
                        iconAnchor: [12, 12]
                    });

                    L.marker([lat, lng], {icon: icon})
                     .bindTooltip(`<b>${shopName}</b><br/>‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏ó‡∏µ‡πà: ${tripId} | ‡∏•‡∏≥‡∏î‡∏±‡∏ö: ${seq}<br/>G95: ${g95} | B7: ${b7}`, {className: 'my'})
                     .addTo(layerRoutes);
                }
            });

            latlngs.push([depotLat, depotLng]); // ‡∏Å‡∏•‡∏±‡∏ö‡∏Ñ‡∏•‡∏±‡∏á

            // ‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
            L.polyline(latlngs, {color: color, weight: 3, opacity: 0.8, dashArray: '6, 6'}).addTo(layerRoutes);

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á Legend ‡∏ö‡∏≠‡∏Å‡∏™‡∏µ
            let legendHTML = `<div class="flex items-center gap-1 text-[10px] font-semibold px-2 py-1 rounded bg-white border shadow-sm">
                <div class="w-3 h-3 rounded-full" style="background-color:${color};"></div>
                ‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏ó‡∏µ‡πà ${tripId}
            </div>`;
            document.getElementById('routeLegend').insertAdjacentHTML('beforeend', legendHTML);
        });

        // Zoom ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        if (layerRoutes.getLayers().length > 0) {
            map.fitBounds(layerRoutes.getBounds(), {padding: [50, 50]});
        }
    }

    // Event ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î-‡∏õ‡∏¥‡∏î‡∏ï‡∏≤‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á
    document.getElementById('toggleRoutes').addEventListener('change', function(e) {
      if(e.target.checked) {
         map.addLayer(layerRoutes);
         if(layerRoutes.getLayers().length > 0) map.fitBounds(layerRoutes.getBounds(), {padding: [50, 50]});
      } else {
         map.removeLayer(layerRoutes);
      }
    });

    // ==========================================
    // 7. MAIN RENDER FUNCTION
    // ==========================================
    function render(){
      layerCustomers.clearLayers(); layerLeads.clearLayers(); layerTrucks.clearLayers();
      layerLines.clearLayers(); layerRadius.clearLayers();

      const selectedBranches = getSelectedRadiusBranches();
      selectedBranches.forEach(code=>{
        const c = BRANCH_RADIUS_CENTERS[code]; if(!c) return;
        const col = RADIUS_COLORS[code] || { stroke: "#0ea5e9", fill: "#0ea5e9" };
        L.circle([c.lat, c.lng], { radius: RADIUS_FILTER_KM * 1000, color: col.stroke, weight: 2, fillColor: col.fill, fillOpacity: 0.10 }).addTo(layerRadius);
      });

      data.trucks.forEach(t=>{
        const lat=+ (t.latitude||t.lat||t.lattitude), lng=+ (t.longitude||t.lng||t.longtitude||t.lon);
        if(!isFinite(lat)||!isFinite(lng)) return;
        L.circleMarker([lat,lng],{radius:7,color:(normHex(t.color)||'#111827'),weight:2,fillColor:'#fff',fillOpacity:1})
          .bindTooltip(`<div class="text-sm font-bold">${t.truck_id}</div>`,{className:'my',sticky:true}).addTo(layerTrucks);
      });

      const cust = data.customers.filter(passFilters);
      const leads = (document.getElementById('toggleLeads').checked ? data.leads: []).filter(passFilters);

      cust.forEach(c=>{
        const lat=+ (c.latitude||c.lat||c.lattitude), lng=+ (c.longitude||c.lng||c.longtitude||c.lon);
        if(!isFinite(lat)||!isFinite(lng)) return;
        const m = L.circleMarker([lat,lng],{ radius:6, color:'#111827', weight:1, fillColor:(getTruckColor(c.truck_id) || '#16a34a'), fillOpacity:0.6 })
          .bindTooltip(tooltipHtml(c,'customer'),{className:'my',sticky:true}).addTo(layerCustomers);
        m.on('click',()=>{ m.bindPopup(popupHtml(c,'customer'), {autoClose:true, closeOnClick:true, className:'my'}).openPopup(); });
      });

      const wantNearest = document.getElementById('toggleNearest').checked;
      leads.forEach(l=>{
        const lat=+ (l.latitude||l.lat||l.lattitude), lng=+ (l.longitude||l.lng||l.longtitude||l.lon);
        if(!isFinite(lat)||!isFinite(lng)) return;
        const marker = L.marker([lat,lng], { icon: makePinIcon(leadPinColor(l.status)) })
          .bindTooltip(tooltipHtml(l,'lead'), { className:'my', sticky:true }).addTo(layerLeads);
        marker.on('click', ()=>{ marker.bindPopup(popupHtml(l,'lead'), {autoClose:true, closeOnClick:true, className:'my'}).openPopup(); });

        if(wantNearest){
          let best={d:Infinity,t:null};
          data.trucks.forEach(t=>{
            const tlat=+(t.latitude||t.lat||t.lattitude), tlng=+(t.longitude||t.lng||t.longtitude||t.lon);
            if(isFinite(tlat)&&isFinite(tlng)){ const d=haversineKm(lat,lng,tlat,tlng); if(d<best.d) best={d,t}; }
          });
          if(best.t){
            L.polyline([[lat,lng],[+(best.t.latitude||best.t.lat||best.t.lattitude),+(best.t.longitude||best.t.lng||best.t.longtitude||best.t.lon)]],{color:'#64748b',weight:1.5,dashArray:'4 4'}).addTo(layerLines);
          }
        }
      });

      // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á (‡∏´‡∏≤‡∏Å‡πÄ‡∏õ‡∏¥‡∏î‡∏ï‡∏≤‡πÑ‡∏ß‡πâ)
      drawRoutes();

      const all=[];
      layerCustomers.eachLayer(l=>all.push(l.getLatLng()));
      layerLeads.eachLayer(l=>all.push(l.getLatLng()));
      layerTrucks.eachLayer(l=>all.push(l.getLatLng()));
      
      // ‡∏à‡∏±‡∏î‡∏°‡∏∏‡∏°‡∏Å‡∏•‡πâ‡∏≠‡∏á (‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÉ‡∏´‡πâ‡πÇ‡∏ü‡∏Å‡∏±‡∏™ ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏¥‡∏î‡∏ï‡∏≤‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏ß‡πâ)
      if(all.length > 0 && (!document.getElementById('toggleRoutes').checked || data.routes.length === 0)) {
          map.fitBounds(L.latLngBounds(all),{padding:[60,60]});
      }
      setSummary({customers:cust,leads});
    }

    // ==========================================
    // 8. DATA LOADING
    // ==========================================
    async function loadAndRender(isRefresh = false){
      try{
        document.getElementById('errorBox').classList.add('hidden');
        if(!isRefresh) document.getElementById('btnRefresh').textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...";
        
        const [settings, customersRaw, leads, trucks, routesRaw] = await Promise.all([
          fetchSheet(SHEETS.settings), 
          fetchSheet(SHEETS.customers), 
          fetchSheet(SHEETS.leads), 
          fetchSheet(SHEETS.trucks),
          fetchSheet(SHEETS.routes).catch(() => []) 
        ]);

        const customersData = customersRaw.map(c => ({ ...c, _statusTH: mapStatusTH(c.status) }));
        truckColorMap = {};
        trucks.forEach(t=>{ const key = normId(t.truck_id); const col = normHex(t.color); if (key && col) truckColorMap[key] = col; });
        
        data = { settings, customers: customersData, leads, trucks, routes: routesRaw };

        const findVal = key => (settings.find(r => (r.key||r.Key||r.setting||'').toString().toUpperCase()===key) || {}).value;
        const cLat = parseFloat(findVal('CENTER_LAT')||16.43), cLng = parseFloat(findVal('CENTER_LNG')||104.61), zoom = parseInt(findVal('ZOOM')||9);
        map.setView([cLat,cLng], zoom);

        const branchOpts = uniqueSorted([ ...customersData.map(c=>c.branch), ...leads.map(l=>l.branch) ]);
        createMultiSelect('branchFilterWrap', branchOpts, 'branch');
        
        const managerOpts = [...ALLOWED_SALES_NAMES, "‡∏≠‡∏∑‡πà‡∏ô‡πÜ"]; 
        createMultiSelect('managerFilterWrap', managerOpts, 'manager');
        
        const truckOpts = uniqueSorted(trucks.map(t=>t.truck_id));
        createMultiSelect('truckFilterWrap', truckOpts, 'truck');

        const statusOpts = [
          { value: "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ Active", label: "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ Active" }, { value: "‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏´‡∏≤‡∏¢", label: "‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏´‡∏≤‡∏¢" },
          { value: "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏´‡∏≤‡∏¢", label: "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏´‡∏≤‡∏¢" }, { value: "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤/‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà", label: "Winback / ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà" },
          { value: "‡∏´‡∏≤‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô 60 ‡∏ß‡∏±‡∏ô", label: "Dormant > 60 ‡∏ß‡∏±‡∏ô" }
        ];
        createMultiSelect('statusFilterWrap', statusOpts, 'status');

        render();
      }catch(err){ showError(err.message||String(err)); }
      finally { document.getElementById('btnRefresh').textContent = "‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"; }
    }

    // ==========================================
    // 9. EXPORT LOGIC
    // ==========================================
    function exportFilteredToExcel(){
      try{
        const filteredCustomers = data.customers.filter(passFilters);
        const filteredLeads = (document.getElementById('toggleLeads').checked ? data.leads : []).filter(passFilters);

        const customerColumns = [
          ['customer_id','Customer ID'], ['customer_name','‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤'], ['_statusTH','‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (TH)'],
          ['branch','‡∏™‡∏≤‡∏Ç‡∏≤'], ['truck_id','‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå'], ['person_incharge','‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö'],
          ['lastest_sales','‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î'], ['notes','‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏'], ['latitude','Latitude'], ['longitude','Longitude']
        ];
        const leadColumns = [
          ['leads_name','‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏µ‡∏î'], ['status','‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡∏µ‡∏î'], ['branch','‡∏™‡∏≤‡∏Ç‡∏≤'],
          ['saler','‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•'], ['nearest_truck_id','‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏™‡∏∏‡∏î'],
          ['province','‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î'], ['district','‡∏≠‡∏≥‡πÄ‡∏†‡∏≠/‡πÄ‡∏Ç‡∏ï'], ['notes','‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏'], ['latitude','Latitude'], ['longitude','Longitude']
        ];

        const mapRows = (rows, columns) => {
          return rows.map(r=>{
            const obj={};
            columns.forEach(([key,label])=>{
              let v = r[key];
              if((key==='latitude'||key==='longitude') && v!==undefined && v!==null && v!==''){
                const num = parseFloat(v);
                v = isFinite(num) ? +num.toFixed(6) : '';
              }
              obj[label] = (v === undefined || v === null) ? '' : v;
            });
            return obj;
          });
        };

        const customerData = mapRows(filteredCustomers, customerColumns);
        const leadData = mapRows(filteredLeads, leadColumns);
        const wb = XLSX.utils.book_new();
        const wsCustomers = XLSX.utils.json_to_sheet(customerData, { origin: 'A1' });
        const wsLeads = XLSX.utils.json_to_sheet(leadData, { origin: 'A1' });
        const fitCols = (columns) => columns.map(([,label])=>({ wch: Math.max(12, label.length + 4) }));
        wsCustomers['!cols'] = fitCols(customerColumns);
        wsLeads['!cols'] = fitCols(leadColumns);
        XLSX.utils.book_append_sheet(wb, wsCustomers, 'Customers (filtered)');
        XLSX.utils.book_append_sheet(wb, wsLeads, 'Leads (filtered)');
        
        const dateStr = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
        const filename = `KCP-Export_${dateStr}_MultiFilter.xlsx`;
        XLSX.writeFile(wb, filename);
      }catch(err){ showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô Excel ‡πÑ‡∏î‡πâ: ' + (err.message || String(err))); }
    }

    // ==========================================
    // 10. EVENT LISTENERS
    // ==========================================
    document.getElementById('btnRefresh').onclick = ()=>loadAndRender(true);
    document.getElementById('btnReset').onclick = ()=>{
       activeFilters = { branch: [], manager: [], truck: [], status: [] };
       document.querySelectorAll('.ms-item input').forEach(c => c.checked = false);
       document.querySelectorAll('.ms-btn span').forEach(s => { s.textContent = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'; s.classList.add('text-gray-500'); s.classList.remove('text-gray-900'); });
       document.querySelectorAll('.radiusChoice').forEach(ch=>{ ch.checked=false; });
       render();
    };
    ['toggleLeads','toggleNearest'].forEach(id => document.getElementById(id).addEventListener('change',render));
    document.querySelectorAll('.radiusChoice').forEach(el=>{ el.addEventListener('change', render); });
    document.getElementById('btnExport').onclick = exportFilteredToExcel;

    // Start App
    loadAndRender();
    setInterval(loadAndRender,300000);

</script>
</body>
</html>
