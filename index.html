<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KCP Map For Sales Management (Active Customer & Leads)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
    #map { position: fixed; inset: 0; height: 100vh; width: 100vw; }
    .leaflet-tooltip.my {
      background:#111827; color:#fff; border:none;
      border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,.2);
      padding:6px 8px;
    }
    .badge { padding:2px 8px; border-radius:999px; font-size:12px; font-weight:600; }
    /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å style ‡πÄ‡∏î‡∏¥‡∏° */
.custom-scrollbar::-webkit-scrollbar { width: 4px; }
.custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
.custom-scrollbar::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }

/* Styles ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Multi Select */
.ms-btn {
  width: 100%; text-align: left; background: white; border: 1px solid #d1d5db;
  border-radius: 0.5rem; padding: 6px 10px; font-size: 0.875rem; 
  display: flex; justify-content: space-between; align-items: center; cursor: pointer;
}
.ms-dropdown {
  position: absolute; top: 100%; left: 0; right: 0; 
  background: white; border: 1px solid #e5e7eb; border-radius: 0.5rem;
  margin-top: 4px; max-height: 200px; overflow-y: auto; z-index: 50;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); display: none;
}
.ms-dropdown.show { display: block; }
.ms-item {
  display: flex; align-items: center; padding: 6px 10px; cursor: pointer; font-size: 0.8rem;
}
.ms-item:hover { background-color: #f3f4f6; }
.ms-item input { margin-right: 8px; }
    
  </style>
</head>
<body class="bg-gray-50">
  
  <div id="topTabs" class="fixed z-[1000] left-4 top-4 flex gap-2">
    <button id="tabMap" class="px-3 py-2 text-sm rounded-xl bg-gray-900 text-white shadow">Map</button>
    <button id="tabDash" class="px-3 py-2 text-sm rounded-xl bg-white/90 backdrop-blur border border-gray-200 text-gray-800 shadow">Dashboard</button>
  </div>

  <div id="viewMap">
    <div id="panel" class="fixed z-[999] top-3 left-3 w-[360px] max-w-[92vw] bg-white/95 backdrop-blur border border-gray-200 rounded-2xl shadow-xl max-h-[90vh] overflow-y-auto custom-scrollbar">
      <div class="p-4 border-b">
        <h1 class="text-xl font-bold text-gray-900">KCP Map For Sales Management</h1>
        <p class="text-xs text-gray-500">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (Multi-Select)</p>
        <p class="text-xs text-gray-500">‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î 15 ‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå 69</p>
      </div>
      <div class="p-4 flex flex-col gap-3">
        <div class="grid grid-cols-2 gap-2">
          <div class="relative">
            <label class="text-xs text-gray-600 mb-1 block">‡∏™‡∏≤‡∏Ç‡∏≤ (Branch)</label>
            <div id="branchFilterWrap" class="relative"></div>
          </div>
          
          <div class="relative">
            <label class="text-xs text-gray-600 mb-1 block">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</label>
            <div id="managerFilterWrap" class="relative"></div>
          </div>

          <div class="relative">
            <label class="text-xs text-gray-600 mb-1 block">‡∏£‡∏ñ‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå (Truck)</label>
            <div id="truckFilterWrap" class="relative"></div>
          </div>

          <div class="relative">
            <label class="text-xs text-gray-600 mb-1 block">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</label>
            <div id="statusFilterWrap" class="relative"></div>
          </div>

          <div class="col-span-2 text-xs text-gray-600 mt-2">
            ‡∏£‡∏±‡∏®‡∏°‡∏µ 100 ‡∏Å‡∏°. ‡∏£‡∏≠‡∏ö‡∏™‡∏≤‡∏Ç‡∏≤ (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏™‡∏≤‡∏Ç‡∏≤)
            <div class="mt-1 flex flex-wrap gap-2">
              <label class="inline-flex items-center gap-1 cursor-pointer">
                <input type="checkbox" class="radiusChoice rounded accent-gray-900" value="ST" />
                <span class="text-xs">ST</span>
              </label>
              <label class="inline-flex items-center gap-1 cursor-pointer">
                <input type="checkbox" class="radiusChoice rounded accent-gray-900" value="KN" />
                <span class="text-xs">KN</span>
              </label>
              <label class="inline-flex items-center gap-1 cursor-pointer">
                <input type="checkbox" class="radiusChoice rounded accent-gray-900" value="MUK" />
                <span class="text-xs">MUK</span>
              </label>
              <label class="inline-flex items-center gap-1 cursor-pointer">
                <input type="checkbox" class="radiusChoice rounded accent-gray-900" value="WNN" />
                <span class="text-xs">WNN</span>
              </label>
            </div>
          </div>
        </div>

        <div class="flex items-center gap-3 mt-1">
          <label class="inline-flex items-center gap-2 text-sm cursor-pointer">
            <input id="toggleLeads" type="checkbox" class="rounded accent-gray-900" checked /> ‡πÅ‡∏™‡∏î‡∏á Leads
          </label>
          <label class="inline-flex items-center gap-2 text-sm cursor-pointer">
            <input id="toggleNearest" type="checkbox" class="rounded accent-gray-900" checked /> ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏ñ‡πÉ‡∏Å‡∏•‡πâ‡∏™‡∏∏‡∏î
          </label>
        </div>

        <div class="flex gap-2 flex-wrap mt-2">
          <button id="btnRefresh" class="px-3 py-2 text-sm rounded-lg bg-gray-900 text-white hover:bg-gray-800 transition">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
          <button id="btnReset" class="px-3 py-2 text-sm rounded-lg border hover:bg-gray-50 transition">‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</button>
          <button id="btnExport" class="px-3 py-2 text-sm rounded-lg bg-emerald-600 text-white hover:bg-emerald-700 transition">Export</button>
        </div>

        <div class="rounded-xl border bg-white p-3 mt-2 shadow-sm">
          <div class="text-xs text-gray-500 mb-1">‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</div>
          <div id="summary" class="text-sm grid grid-cols-2 gap-x-3 gap-y-1">
            <div>Customers:</div><div id="sumCustomers" class="font-semibold">-</div>
            <div>Leads:</div><div id="sumLeads" class="font-semibold">-</div>
            
            <div class="text-emerald-600">Active:</div>
            <div id="sumActive" class="font-semibold text-emerald-600">-</div>
            
            <div class="text-amber-600">Risky:</div>
            <div id="sumRisky" class="font-semibold text-amber-600">-</div>
            
            <div class="text-red-600">Lost:</div>
            <div id="sumLost" class="font-semibold text-red-600">-</div>
            
            <div class="text-blue-600">Winback:</div>
            <div id="sumWinback" class="font-semibold text-blue-600">-</div>
            
            <div class="text-gray-400">Dormant:</div>
            <div id="sumDormant" class="font-semibold text-gray-400">-</div>
          </div>
          <div id="errorBox" class="text-xs text-red-600 mt-2 hidden"></div>
        </div>
      </div>
    </div>
    <div id="map"></div>
  </div>

<div id="viewDash" class="hidden fixed inset-0 overflow-auto bg-gray-50/50">
    <div class="max-w-[1800px] mx-auto px-4 pt-16 pb-12"> <div class="flex flex-col lg:flex-row lg:items-end justify-between gap-3 mb-4">
        <div>
          <div class="text-2xl font-extrabold text-gray-900">CRM Dashboard</div>
          <div class="text-sm text-gray-500">‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏£‡∏ñ‡∏£‡∏≤‡∏¢‡∏Ñ‡∏±‡∏ô</div>
        </div>
        <div class="flex flex-wrap items-end gap-2 bg-white p-2 rounded-xl border shadow-sm">
          <div class="w-32"> 
            <label class="text-[10px] text-gray-600 font-semibold px-1">‡∏™‡∏≤‡∏Ç‡∏≤ (BU)</label>
            <select id="crmBranchFilter" class="w-full text-s border-none bg-gray-50 rounded-lg p-1.5 focus:ring-0 cursor-pointer hover:bg-gray-100"></select>
          </div>
          <div class="w-48">
            <label class="text-[10px] text-gray-600 font-semibold px-1">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</label>
            <select id="crmOwnerFilter" class="w-full text-s border-none bg-gray-50 rounded-lg p-1.5 focus:ring-0 cursor-pointer hover:bg-gray-100"></select>
          </div>
          <div class="w-60">
            <label class="text-[14px] text-gray-600 font-semibold px-1">‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
            <div class="grid grid-cols-2 gap-1">
              <input id="dashStartDate" type="date" class="w-full text-xs border-none bg-gray-50 rounded-lg p-1.5 focus:ring-0 cursor-pointer" />
              <input id="dashEndDate" type="date" class="w-full text-xs border-none bg-gray-50 rounded-lg p-1.5 focus:ring-0 cursor-pointer" />
            </div>
          </div>
          <button id="btnDashRefresh" class="px-4 py-1.5 text-xs font-bold rounded-lg bg-gray-900 text-white shadow hover:bg-gray-800 transition">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
        </div>
      </div>

      <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-5">
        <div class="rounded-xl border bg-white px-5 py-4 shadow-sm flex flex-col justify-between">
          <div class="text-[14px] text-gray-500 uppercase tracking-wide">Tasks ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
          <div class="flex items-baseline gap-2 mt-1">
            <div class="text-3xl font-black text-gray-900" id="kpiTaskTotal">-</div>
            <div class="text-s text-gray-500">‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°: <span class="font-bold text-red-600" id="kpiTaskFollow">-</span></div>
          </div>
        </div>
        <div class="rounded-xl border bg-white px-5 py-4 shadow-sm flex flex-col justify-between">
          <div class="text-[14px] text-gray-500 uppercase tracking-wide">% Task Completed</div>
          <div class="flex items-baseline gap-2 mt-1">
            <div class="text-3xl font-black text-emerald-600" id="kpiTaskRate">-</div>
            <div class="text-s text-gray-500">‡πÄ‡∏™‡∏£‡πá‡∏à: <span class="font-bold text-gray-800" id="kpiTaskDone">-</span></div>
          </div>
        </div>
        <div class="rounded-xl border bg-white px-5 py-4 shadow-sm flex flex-col justify-between">
          <div class="text-[14px] text-gray-500 uppercase tracking-wide">Leads ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
          <div class="flex items-baseline gap-2 mt-1">
            <div class="text-3xl font-black text-gray-900" id="kpiLeadTotal">-</div>
            <div class="text-s text-gray-500">‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°: <span class="font-bold text-red-600" id="kpiLeadFollow">-</span></div>
          </div>
        </div>
        <div class="rounded-xl border bg-white px-5 py-4 shadow-sm flex flex-col justify-between">
          <div class="text-[14px] text-gray-500 uppercase tracking-wide">% Leads Conversion</div>
          <div class="flex items-baseline gap-2 mt-1">
            <div class="text-3xl font-black text-blue-600" id="kpiLeadRate">-</div>
            <div class="text-s text-gray-500">‡∏õ‡∏¥‡∏î‡πÑ‡∏î‡πâ: <span class="font-bold text-gray-800" id="kpiLeadWon">-</span></div>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 mb-8">
        <div class="rounded-xl border bg-white p-4 shadow-sm">
          <div class="text-s font-bold text-gray-900 mb-3 border-b pb-2">Tasks: ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô</div>
          <div class="h-64"><canvas id="chartTaskStatus"></canvas></div>
        </div>
        <div class="rounded-xl border bg-white p-4 shadow-sm">
          <div class="text-s font-bold text-gray-900 mb-3 border-b pb-2">Leads: ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô</div>
          <div class="h-64"><canvas id="chartLeadStatus"></canvas></div>
        </div>
        <div class="rounded-xl border bg-white p-4 shadow-sm">
           <div class="flex items-center justify-between border-b pb-2 mb-3">
             <div class="text-s font-bold text-gray-900">Customers Overview</div>
             <div class="text-[10px] text-gray-400">: Customers</div>
           </div>
           <div class="h-64"><canvas id="chartCustomerStatus"></canvas></div>
        </div>

        <div class="rounded-xl border bg-white p-4 shadow-sm">
          <div class="text-s font-bold text-gray-900 mb-3 border-b pb-2">Tasks: ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</div>
          <div class="h-64"><canvas id="chartTaskContact"></canvas></div>
        </div>
        <div class="rounded-xl border bg-white p-4 shadow-sm">
          <div class="text-s font-bold text-gray-900 mb-3 border-b pb-2">Tasks: ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</div>
          <div class="h-64"><canvas id="chartTaskChannel"></canvas></div>
        </div>
        <div class="rounded-xl border bg-white p-4 shadow-sm">
           <div class="flex items-center justify-between border-b pb-2 mb-3">
             <div class="text-s font-bold text-gray-900">Top ‡∏£‡∏ñ‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á/‡∏´‡∏≤‡∏¢ (Risky+Lost)</div>
             <div class="text-[10px] text-gray-400">‡∏≠‡∏¥‡∏á‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>
           </div>
           <div class="h-64"><canvas id="chartTruckRisk"></canvas></div>
        </div>
      </div>

      <div class="grid grid-cols-1 xl:grid-cols-2 gap-6 mb-8">
        
        <div class="rounded-2xl border border-gray-200 bg-white p-5 shadow-md h-full">
            <div class="flex items-center justify-between mb-4 border-b pb-3">
              <div>
                <div class="text-lg font-bold text-gray-900">üöö Truck Efficiency: ‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏û‡∏≠‡∏£‡πå‡∏ï‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≤‡∏°‡∏£‡∏ñ (100%)</div>
                <div class="text-sm text-gray-500">‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ Active ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤</div>
              </div>
            </div>
            <div class="h-[550px] w-full"><canvas id="chartTruckEfficiency"></canvas></div>
        </div>

        <div class="rounded-2xl border border-gray-200 bg-white shadow-md flex flex-col h-[650px] xl:h-auto"> <div class="p-5 bg-gray-50 border-b flex justify-between items-center flex-shrink-0">
            <div>
                 <div class="text-lg font-bold text-gray-900">üìã ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏£‡∏ñ (Detailed List)</div>
                 <div class="text-xs text-gray-500">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏¢‡∏Å‡∏£‡∏≤‡∏¢‡∏£‡∏ñ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö (Top 3)</div>
            </div>
          </div>
          <div class="overflow-auto flex-grow h-[550px] custom-scrollbar">
            <table class="min-w-full text-sm">
              <thead class="text-gray-500 bg-white sticky top-0 shadow-sm z-10 text-xs uppercase tracking-wider">
                <tr>
                  <th class="text-left p-3 bg-gray-100 font-semibold w-24">‡∏£‡∏ñ</th>
                  <th class="text-left p-3 bg-gray-100 font-semibold">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</th>
                  <th class="text-right p-3 bg-gray-100 font-semibold w-16">‡∏£‡∏ß‡∏°</th>
                  <th class="text-right p-3 bg-gray-100 font-semibold text-emerald-700 w-16">Active</th>
                  <th class="text-right p-3 bg-gray-100 font-semibold text-amber-600 w-16">Risky</th>
                  <th class="text-right p-3 bg-gray-100 font-semibold text-red-600 w-16">Lost</th>
                  <th class="text-right p-3 bg-gray-100 font-semibold text-blue-600 w-20">Winback</th>
                  <th class="text-right p-3 bg-gray-100 font-semibold text-gray-500 w-20">Dormant</th>
                </tr>
              </thead>
              <tbody id="truckTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="border-t pt-10">
        <h2 class="text-lg font-bold text-gray-900 mb-4 flex items-center gap-2">
            üìä ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà & ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á (Actual Visits)
            <span class="text-xs font-normal text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Sheet "leads"</span>
        </h2>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-4">
          <div class="grid grid-cols-3 lg:grid-cols-1 gap-4 lg:col-span-1">
              <div class="rounded-xl bg-slate-800 text-white p-4 shadow relative overflow-hidden flex flex-col justify-center h-28">
                 <div class="relative z-10">
                   <div class="text-slate-300 text-[14px] uppercase tracking-wider">‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏ö (‡∏£‡∏≤‡∏¢)</div>
                   <div class="text-3xl font-bold mt-1" id="actVisitCount">-</div>
                 </div>
                 <div class="absolute -right-4 -bottom-6 w-20 h-20 rounded-full border-4 border-slate-600/30"></div>
              </div>
              <div class="rounded-xl bg-emerald-600 text-white p-4 shadow relative overflow-hidden flex flex-col justify-center h-28">
                  <div class="relative z-10">
                   <div class="text-emerald-100 text-[14px] uppercase tracking-wider">‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ (‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ)</div>
                   <div class="text-3xl font-bold mt-1" id="actSaleRange">-</div>
                   <div class="text-xs opacity-80 mt-1">Conv: <span id="actConvRange">-</span></div>
                  </div>
                  <div class="absolute -right-4 -bottom-6 w-20 h-20 rounded-full border-4 border-emerald-400/30"></div>
              </div>
              <div class="rounded-xl bg-blue-600 text-white p-4 shadow relative overflow-hidden flex flex-col justify-center h-28">
                  <div class="relative z-10">
                   <div class="text-blue-100 text-[14px] uppercase tracking-wider">‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ (‡∏™‡∏∞‡∏™‡∏°)</div>
                   <div class="text-3xl font-bold mt-1" id="actSaleAcc">-</div>
                  </div>
                  <div class="absolute -right-4 -bottom-6 w-20 h-20 rounded-full border-4 border-blue-400/30"></div>
              </div>
          </div>

          <div class="lg:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4">
             <div class="rounded-xl border bg-white p-4 shadow-sm h-full">
               <div class="text-s font-bold text-gray-900 mb-3">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏ö (‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö)</div>
               <div class="h-72"><canvas id="chartActualVisits"></canvas></div>
             </div>
             <div class="rounded-xl border bg-white p-4 shadow-sm h-full">
               <div class="text-s font-bold text-gray-900 mb-3">‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ (‡∏£‡∏≤‡∏¢)</div>
               <div class="h-72"><canvas id="chartActualSales"></canvas></div>
             </div>
          </div>
        </div>
      </div>

    </div>
  </div>


<script>
    // ==========================================
    // 1. CONFIGURATION & CONSTANTS
    // ==========================================
    const SHEET_ID = "1Vo4d5_bJPzqHjQDABLTcOrPhqx1tUJ3P11W3cRjfmAo";
    const SHEETS = { customers: "Customers", leads: "leads", trucks: "Trucks", settings: "Settings" };
    const CRM_SHEET_ID = "1Nxbvm7R6AqwTpUtI8AHEVY2HZv0gAnYcrC_lBDTe5os";
    const CRM_SHEETS = { dataset: "Dataset" };

    const ALLOWED_SALES_NAMES = [
      "‡∏ä‡∏≤‡∏ç‡∏ä‡∏±‡∏¢ (‡∏ï‡πâ‡∏≠‡∏°)", "‡∏ì‡∏±‡∏è‡∏ê‡∏†‡∏£‡∏ì‡πå (‡∏≠‡πâ‡∏≠‡∏°)", "‡∏ò‡∏µ‡∏£‡∏∞‡∏û‡∏±‡∏ô‡∏ò‡πå (‡∏à‡∏∏‡πà‡∏ô)", "‡∏ö‡∏∏‡∏ç‡∏¢‡πå‡∏°‡∏ô‡∏±‡∏™ (‡∏Ñ‡∏∏‡∏ì‡∏ù‡∏ô)", "‡∏õ‡∏¥‡∏¢‡∏ò‡∏¥‡∏î‡∏≤ (‡∏≠‡∏∏‡πâ‡∏¢)" , "‡∏™‡∏∏‡∏†‡∏≤‡∏†‡∏¥‡πÑ‡∏• (‡πÑ‡∏Å‡πà)"
    ];

    const BRANCH_RADIUS_CENTERS = {
      ST:  { lat: 16.381029272179042, lng: 103.34881852164082 },
      KN:  { lat: 16.71600409911031,  lng: 103.08205194412724 },
      MUK: { lat: 16.43599207530131,  lng: 104.61612804232725 },
      WNN: { lat: 17.6293190999291,   lng: 103.7676571040772 }
    };
    const RADIUS_FILTER_KM = 100;
    const RADIUS_COLORS = {
      ST:  { stroke: "#3b82f6", fill: "#3b82f6" },
      KN:  { stroke: "#22c55e", fill: "#22c55e" },
      MUK: { stroke: "#a855f7", fill: "#a855f7" },
      WNN: { stroke: "#ef4444", fill: "#ef4444" } 
    };

    const STATUS_CODE_TO_TH = {
      ACTIVE: "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ Active", RISKY: "‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏´‡∏≤‡∏¢", LOST: "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏´‡∏≤‡∏¢",
      WINBACK: "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤/‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà", DORMANT: "‡∏´‡∏≤‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô 60 ‡∏ß‡∏±‡∏ô",
    };

    // ==========================================
    // 2. STATE MANAGEMENT & GLOBALS
    // ==========================================
    // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Multi-Select (‡∏ñ‡πâ‡∏≤ Array ‡∏ß‡πà‡∏≤‡∏á = ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)
    let activeFilters = { branch: [], manager: [], truck: [], status: [] };
    
    let data = { customers: [], leads: [], trucks: [], settings: [] };
    let truckColorMap = {};

    // Global Charts Variables
    let chartTaskStatus, chartLeadStatus, chartTaskContact, chartTaskChannel;
    let chartCustomerStatus, chartTruckRisk, chartTruckEfficiency;
    let chartActualVisits, chartActualSales; 

    // Map & Layers
    const map = L.map('map');
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
    const layerCustomers=L.layerGroup().addTo(map),
          layerLeads=L.layerGroup().addTo(map),
          layerTrucks=L.layerGroup().addTo(map),
          layerLines=L.layerGroup().addTo(map),
          layerRadius=L.layerGroup().addTo(map);

    // ==========================================
    // 3. UTILITY FUNCTIONS
    // ==========================================
    function showError(msg){
      console.error(msg);
      const box = document.getElementById('errorBox');
      if(box) { box.textContent = msg; box.classList.remove('hidden'); }
    }

    function norm(v){ return (v==null?'':String(v)).trim(); }
    const normId = (id) => (id || "").toString().trim().toLowerCase();
    
    const normHex = (c) => {
      if (!c) return "";
      const raw = String(c).trim().replace(/^#/, "");
      if (/^[0-9A-Fa-f]{6}$/.test(raw)) return "#" + raw.toUpperCase();
      return "";
    };

    const uniqueSorted = (arr) => [...new Set(arr.filter(Boolean))].sort((a,b)=>a.localeCompare(b,'th'));

    async function fetchSheet(sheetName, sheetId = SHEET_ID) {
      const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}&tq=`;
      const res = await fetch(url, { cache: "no-store" });
      const text = await res.text();
      const json = JSON.parse(text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1));
      const cols = json.table.cols.map(c => c.label || c.id);
      const rows = json.table.rows.map(r => (r.c || []).map(c => c ? (c.f ?? c.v ?? "") : ""));
      return rows.map(r => Object.fromEntries(r.map((v,i) => [cols[i] || `col${i+1}`, v])));
    }

    function getTruckColor(id) {
      const key = normId(id);
      return truckColorMap[key] || "";
    }

    function getOwnerGroup(rawName) {
        const n = norm(rawName);
        if(!n) return ""; 
        if (ALLOWED_SALES_NAMES.includes(n)) return n;
        return "‡∏≠‡∏∑‡πà‡∏ô‡πÜ";
    }

    function mapStatusTH(raw){
      if(raw==null) return "";
      const s = String(raw).trim();
      const sl = s.toLowerCase();
      if (sl === 'active') return '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ Active';
      if (sl === 'risky to lost') return '‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏´‡∏≤‡∏¢';
      if (sl === 'lost customer') return '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏´‡∏≤‡∏¢';
      if (sl === 'winback/new customer' || sl === 'winback' || sl === 'new customer' || sl === 'new') return '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤/‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà';
      if (sl === 'dormant >60' || sl === 'dormant' || sl === 'deep lost' || sl === 'lost >60') return '‡∏´‡∏≤‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô 60 ‡∏ß‡∏±‡∏ô';
      if (s === '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ active') return '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ Active';
      return s;
    }

    // ==========================================
    // 4. MULTI-SELECT LOGIC (NEW)
    // ==========================================
    function createMultiSelect(wrapperId, options, filterKey) {
      const wrapper = document.getElementById(wrapperId);
      if(!wrapper) return;
      wrapper.innerHTML = ''; 

      // 1. Button
      const btn = document.createElement('div');
      btn.className = 'ms-btn';
      btn.innerHTML = `<span class="truncate text-gray-500">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span> <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>`;
      
      // 2. Dropdown
      const dropdown = document.createElement('div');
      dropdown.className = 'ms-dropdown custom-scrollbar';

      // 3. Items
      options.forEach(opt => {
        const val = opt.value || opt;
        const txt = opt.label || opt;
        
        const item = document.createElement('label');
        item.className = 'ms-item';
        
        const chk = document.createElement('input');
        chk.type = 'checkbox';
        chk.value = val;
        chk.className = 'rounded accent-gray-900';
        
        if(activeFilters[filterKey].includes(val)) chk.checked = true;

        chk.addEventListener('change', () => {
          updateSelected(filterKey, wrapper, btn);
          render(); // Re-render Map immediately
        });

        item.appendChild(chk);
        item.appendChild(document.createTextNode(" " + txt));
        dropdown.appendChild(item);
      });

      wrapper.appendChild(btn);
      wrapper.appendChild(dropdown);

      // Toggle Logic
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        // Close others
        document.querySelectorAll('.ms-dropdown').forEach(d => {
          if(d !== dropdown) d.classList.remove('show');
        });
        dropdown.classList.toggle('show');
      });

      updateSelected(filterKey, wrapper, btn);
    }

    function updateSelected(key, wrapper, btn) {
      const chks = wrapper.querySelectorAll('input[type="checkbox"]:checked');
      const values = Array.from(chks).map(c => c.value);
      activeFilters[key] = values;

      const span = btn.querySelector('span');
      if(values.length === 0) {
        span.textContent = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
        span.classList.add('text-gray-500');
        span.classList.remove('text-gray-900');
      } else {
        span.textContent = `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ${values.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
        span.classList.remove('text-gray-500');
        span.classList.add('text-gray-900');
      }
    }

    // Close dropdowns when clicking outside
    document.addEventListener('click', () => {
      document.querySelectorAll('.ms-dropdown').forEach(d => d.classList.remove('show'));
    });

    // ==========================================
    // 5. MAP LOGIC & RENDERING
    // ==========================================
    const haversineKm=(a,b,c,d)=>{
      const R=6371,toRad=x=>x*Math.PI/180;
      const dLat=toRad(c-a),dLon=toRad(d-b);
      const h=Math.sin(dLat/2)**2+Math.cos(toRad(a))*Math.cos(toRad(c))*Math.sin(dLon/2)**2;
      return 2*R*Math.asin(Math.sqrt(h));
    };
    const gmapsUrl = (lat,lng) => `http://googleusercontent.com/maps.google.com/maps?q=${encodeURIComponent(lat+","+lng)}`;

    function makePinIcon(colorHex){
      const c = (colorHex||'#EF4444').replace('#','');
      const svg = `<svg xmlns="http://www.w3.org/2000/svg" width="26" height="40" viewBox="0 0 26 40"><defs><filter id="shadow" x="-20%" y="-10%" width="140%" height="140%"><feGaussianBlur in="SourceAlpha" stdDeviation="1.5"/><feOffset dx="0" dy="1" result="o"/><feMerge><feMergeNode in="o"/><feMergeNode in="SourceGraphic"/></feMerge></filter></defs><path filter="url(#shadow)" d="M13 0C6.373 0 1 5.373 1 12c0 8.25 12 27 12 27s12-18.75 12-27C25 5.373 19.627 0 13 0z" fill="#${c}" stroke="#7a7a7a" stroke-width="0.6"/><circle cx="13" cy="12" r="5" fill="#fff"/></svg>`;
      return L.icon({
        iconUrl: 'data:image/svg+xml;utf8,' + encodeURIComponent(svg),
        iconSize: [18,28], iconAnchor: [9,28], popupAnchor: [0,-24], tooltipAnchor: [0,-24]
      });
    }

    function leadPinColor(statusText){
      const s = String(statusText || '').trim();
      return (s === '‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢') ? '#308320' : '#EF4444';
    }

    const FIELD_LABELS = {
      customer_id: "‡∏£‡∏´‡∏±‡∏™‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤", customer_name: "‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤", _statusTH: "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤",
      branch: "‡∏™‡∏≤‡∏Ç‡∏≤", truck_id: "‡∏£‡∏ñ", person_incharge: "‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö",
      lastest_sales: "‡∏ö‡∏¥‡∏•‡∏Ç‡∏≤‡∏¢‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î", notes: "‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏", latitude: "Latitude", longitude: "Longtitude",
      lead_id: "‡∏£‡∏´‡∏±‡∏™ Lead", leads_name: "‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏µ‡∏î", status: "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Lead",
      saler: "‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢", province: "‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î", district: "‡∏≠‡∏≥‡πÄ‡∏†‡∏≠", nearest_truck_id: "‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î"
    };

    function buildRowsHtml(obj, fields, isDark = true){
      const labelColor = isDark ? "text-slate-300" : "text-gray-500";
      const valueColor = isDark ? "text-white" : "text-gray-900";
      return fields.filter(k => obj[k] !== undefined && obj[k] !== null && String(obj[k]).trim() !== "")
        .map(k => `<tr><td class="pr-2 ${labelColor} whitespace-nowrap">${FIELD_LABELS[k] || k}</td><td class="font-semibold ${valueColor}">${obj[k]}</td></tr>`).join('');
    }

    function tooltipHtml(obj,type){
      const fields = (type==='customer')
        ? ['customer_id','customer_name','lastest_sales','_statusTH','branch','truck_id','person_incharge','notes']
        : ['leads_name','status','province','district','nearest_truck_id','saler','branch','notes'];
      const rows = buildRowsHtml(obj, fields, true); 
      const badge= type==='customer'
        ? `<span class="badge" style="background:${getTruckColor(obj.truck_id)||'#16a34a'};color:white">${obj._statusTH||''}</span>`
        : `<span class="badge" style="background:#2563eb;color:white">LEAD</span>`;
      return `<div class="text-sm"><div class="mb-1 font-bold">${obj.customer_name||obj.leads_name||obj.truck_id} ${badge}</div><table class="text-xs">${rows}</table></div>`;
    }

    function popupHtml(obj,type){
      const lat = parseFloat(obj.latitude||obj.lat||obj.lattitude);
      const lng = parseFloat(obj.longitude||obj.lng||obj.longtitude||obj.lon);
      const fields = (type==='customer')
        ? ['customer_id','customer_name','lastest_sales','_statusTH','branch','truck_id','person_incharge','notes']
        : ['leads_name','status','province','district','nearest_truck_id','saler','branch','notes'];
      const rows = buildRowsHtml(obj, fields, false); 
      const gmBtn = (isFinite(lat)&&isFinite(lng)) ? `<a href="${gmapsUrl(lat,lng)}" target="_blank" rel="noopener" class="mt-2 inline-block text-xs font-semibold text-blue-600 underline">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô Google Maps</a>`:'';
      return `<div class="text-sm"><div class="mb-1 font-bold text-gray-900">${obj.customer_name||obj.leads_name||obj.truck_id}</div><table class="text-xs">${rows}</table>${gmBtn}</div>`;
    }

    function getSelectedRadiusBranches(){
      return Array.from(document.querySelectorAll('.radiusChoice')).filter(ch => ch.checked).map(ch => ch.value).filter(v => !!BRANCH_RADIUS_CENTERS[v]);
    }

    function passFilters(item){
      // 1. Branch
      if(activeFilters.branch.length > 0 && !activeFilters.branch.includes(item.branch || '')) return false;
      // 2. Manager (Group)
      if(activeFilters.manager.length > 0) {
        const groupName = getOwnerGroup(item.person_incharge || item.saller); 
        if(!activeFilters.manager.includes(groupName)) return false;
      }
      // 3. Truck
      if(activeFilters.truck.length > 0) {
        const tid = item.truck_id || item.nearest_truck_id || '';
        if(!activeFilters.truck.includes(tid)) return false;
      }
      // 4. Status
      if(activeFilters.status.length > 0) {
        const itemStatus = item._statusTH || "";
        if(!activeFilters.status.includes(itemStatus)) return false;
      }
      // 5. Radius
      const selectedBranches = getSelectedRadiusBranches();
      if(selectedBranches.length){
        const lat = parseFloat(item.latitude||item.lat||item.lattitude);
        const lng = parseFloat(item.longitude||item.lng||item.longtitude||item.lon);
        if(!isFinite(lat) || !isFinite(lng)) return false;
        let insideAny = false;
        for(const code of selectedBranches){
          const center = BRANCH_RADIUS_CENTERS[code];
          const d = haversineKm(center.lat, center.lng, lat, lng);
          if(d <= RADIUS_FILTER_KM){ insideAny = true; break; }
        }
        if(!insideAny) return false;
      }
      return true;
    }

   function setSummary({customers, leads}){
      sumCustomers.textContent = customers.length;
      sumLeads.textContent = leads.length;

      // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
      const count = (st) => customers.filter(c => (c._statusTH||'') === st).length;

      document.getElementById('sumActive').textContent = count('‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ Active');
      document.getElementById('sumRisky').textContent  = count('‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏´‡∏≤‡∏¢');
      document.getElementById('sumLost').textContent   = count('‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏´‡∏≤‡∏¢');
      document.getElementById('sumWinback').textContent = count('‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤/‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà');
      document.getElementById('sumDormant').textContent = count('‡∏´‡∏≤‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô 60 ‡∏ß‡∏±‡∏ô');
    }

    function render(){
      layerCustomers.clearLayers(); layerLeads.clearLayers(); layerTrucks.clearLayers();
      layerLines.clearLayers(); layerRadius.clearLayers();

      const selectedBranches = getSelectedRadiusBranches();
      selectedBranches.forEach(code=>{
        const c = BRANCH_RADIUS_CENTERS[code];
        if(!c) return;
        const col = RADIUS_COLORS[code] || { stroke: "#0ea5e9", fill: "#0ea5e9" };
        L.circle([c.lat, c.lng], { radius: RADIUS_FILTER_KM * 1000, color: col.stroke, weight: 2, fillColor: col.fill, fillOpacity: 0.10 }).addTo(layerRadius);
      });

      // Render Trucks
      data.trucks.forEach(t=>{
        const lat=+ (t.latitude||t.lat||t.lattitude), lng=+ (t.longitude||t.lng||t.longtitude||t.lon);
        if(!isFinite(lat)||!isFinite(lng)) return;
        const col=normHex(t.color)||'#111827';
        L.circleMarker([lat,lng],{radius:7,color:col,weight:2,fillColor:'#fff',fillOpacity:1})
          .bindTooltip(`<div class="text-sm font-bold">${t.truck_id}</div>`,{className:'my',sticky:true})
          .addTo(layerTrucks);
      });

      const cust = data.customers.filter(passFilters);
      const leads = (document.getElementById('toggleLeads').checked ? data.leads: []).filter(passFilters);

      // Render Customers
      cust.forEach(c=>{
        const lat=+ (c.latitude||c.lat||c.lattitude), lng=+ (c.longitude||c.lng||c.longtitude||c.lon);
        if(!isFinite(lat)||!isFinite(lng)) return;
        const col=getTruckColor(c.truck_id) || '#16a34a';
        const m = L.circleMarker([lat,lng],{ radius:6, color:'#111827', weight:1, fillColor:col, fillOpacity:0.6 })
          .bindTooltip(tooltipHtml(c,'customer'),{className:'my',sticky:true})
          .addTo(layerCustomers);
        m.on('click',()=>{ m.bindPopup(popupHtml(c,'customer'), {autoClose:true, closeOnClick:true, className:'my'}).openPopup(); });
      });

      // Render Leads
      const wantNearest = document.getElementById('toggleNearest').checked;
      leads.forEach(l=>{
        const lat=+ (l.latitude||l.lat||l.lattitude), lng=+ (l.longitude||l.lng||l.longtitude||l.lon);
        if(!isFinite(lat)||!isFinite(lng)) return;
        const pinCol = leadPinColor(l.status);
        const marker = L.marker([lat,lng], { icon: makePinIcon(pinCol) })
          .bindTooltip(tooltipHtml(l,'lead'), { className:'my', sticky:true })
          .addTo(layerLeads);
        marker.on('click', ()=>{ marker.bindPopup(popupHtml(l,'lead'), {autoClose:true, closeOnClick:true, className:'my'}).openPopup(); });

        if(wantNearest){
          let best={d:Infinity,t:null};
          data.trucks.forEach(t=>{
            const tlat=+(t.latitude||t.lat||t.lattitude), tlng=+(t.longitude||t.lng||t.longtitude||t.lon);
            if(!isFinite(tlat)||!isFinite(tlng)) return;
            const d=haversineKm(lat,lng,tlat,tlng);
            if(d<best.d) best={d,t};
          });
          if(best.t){
            const tlat=+(best.t.latitude||best.t.lat||best.t.lattitude), tlng=+(best.t.longitude||best.t.lng||best.t.longtitude||best.t.lon);
            L.polyline([[lat,lng],[tlat,tlng]],{color:'#64748b',weight:1.5,dashArray:'4 4'}).addTo(layerLines);
          }
        }
      });

      const all=[];
      layerCustomers.eachLayer(l=>all.push(l.getLatLng()));
      layerLeads.eachLayer(l=>all.push(l.getLatLng()));
      layerTrucks.eachLayer(l=>all.push(l.getLatLng()));
      if(all.length) map.fitBounds(L.latLngBounds(all),{padding:[60,60]});
      setSummary({customers:cust,leads});
    }

    async function loadAndRender(isRefresh = false){
      try{
        document.getElementById('errorBox').classList.add('hidden');
        if(!isRefresh) document.getElementById('btnRefresh').textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...";
        
        const [settings, customersRaw, leads, trucks] = await Promise.all([
          fetchSheet(SHEETS.settings), fetchSheet(SHEETS.customers), fetchSheet(SHEETS.leads), fetchSheet(SHEETS.trucks)
        ]);
        const customersData = customersRaw.map(c => ({ ...c, _statusTH: mapStatusTH(c.status) }));
        truckColorMap = {};
        trucks.forEach(t=>{
          const key = normId(t.truck_id);
          const col = normHex(t.color);
          if (key && col) truckColorMap[key] = col;
        });
        data={settings, customers: customersData, leads, trucks};

        // Map Setup
        const findVal = key => (settings.find(r => (r.key||r.Key||r.setting||'').toString().toUpperCase()===key) || {}).value;
        const cLat = parseFloat(findVal('CENTER_LAT')||16.43), cLng = parseFloat(findVal('CENTER_LNG')||103.49), zoom = parseInt(findVal('ZOOM')||9);
        map.setView([cLat,cLng], zoom);

        // CREATE MULTI-SELECTS
        const branchOpts = uniqueSorted([ ...customersData.map(c=>c.branch), ...leads.map(l=>l.branch) ]);
        createMultiSelect('branchFilterWrap', branchOpts, 'branch');
        
        const managerOpts = [...ALLOWED_SALES_NAMES, "‡∏≠‡∏∑‡πà‡∏ô‡πÜ"]; 
        createMultiSelect('managerFilterWrap', managerOpts, 'manager');
        
        const truckOpts = uniqueSorted(trucks.map(t=>t.truck_id));
        createMultiSelect('truckFilterWrap', truckOpts, 'truck');

        const statusOpts = [
          { value: "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ Active", label: "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ Active" },
          { value: "‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏´‡∏≤‡∏¢", label: "‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏´‡∏≤‡∏¢" },
          { value: "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏´‡∏≤‡∏¢", label: "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏´‡∏≤‡∏¢" },
          { value: "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤/‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà", label: "Winback / ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà" },
          { value: "‡∏´‡∏≤‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô 60 ‡∏ß‡∏±‡∏ô", label: "Dormant > 60 ‡∏ß‡∏±‡∏ô" }
        ];
        createMultiSelect('statusFilterWrap', statusOpts, 'status');

        render();
      }catch(err){ showError(err.message||String(err)); }
      finally { document.getElementById('btnRefresh').textContent = "‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"; }
    }

    // ==========================================
    // 6. EXPORT LOGIC
    // ==========================================
    function exportFilteredToExcel(){
      try{
        const filteredCustomers = data.customers.filter(passFilters);
        const filteredLeads = (document.getElementById('toggleLeads').checked ? data.leads : []).filter(passFilters);

        const customerColumns = [
          ['customer_id','Customer ID'], ['customer_name','‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤'], ['_statusTH','‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (TH)'],
          ['branch','‡∏™‡∏≤‡∏Ç‡∏≤'], ['truck_id','‡∏£‡∏´‡∏±‡∏™‡∏£‡∏ñ‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå'], ['person_incharge','‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö'],
          ['lastest_sales','‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î'], ['notes','‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏'], ['latitude','Latitude'], ['longitude','Longitude']
        ];
        const leadColumns = [
          ['leads_name','‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏µ‡∏î'], ['status','‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡∏µ‡∏î'], ['branch','‡∏™‡∏≤‡∏Ç‡∏≤'],
          ['saler','‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•'], ['nearest_truck_id','‡∏£‡∏ñ‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏™‡∏∏‡∏î'],
          ['province','‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î'], ['district','‡∏≠‡∏≥‡πÄ‡∏†‡∏≠/‡πÄ‡∏Ç‡∏ï'], ['notes','‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏'], ['latitude','Latitude'], ['longitude','Longitude']
        ];

        const mapRows = (rows, columns) => {
          return rows.map(r=>{
            const obj={};
            columns.forEach(([key,label])=>{
              let v = r[key];
              if((key==='latitude'||key==='longitude') && v!==undefined && v!==null && v!==''){
                const num = parseFloat(v);
                v = isFinite(num) ? +num.toFixed(6) : '';
              }
              obj[label] = (v === undefined || v === null) ? '' : v;
            });
            return obj;
          });
        };

        const customerData = mapRows(filteredCustomers, customerColumns);
        const leadData = mapRows(filteredLeads, leadColumns);
        const wb = XLSX.utils.book_new();
        const wsCustomers = XLSX.utils.json_to_sheet(customerData, { origin: 'A1' });
        const wsLeads = XLSX.utils.json_to_sheet(leadData, { origin: 'A1' });
        const fitCols = (columns) => columns.map(([,label])=>({ wch: Math.max(12, label.length + 4) }));
        wsCustomers['!cols'] = fitCols(customerColumns);
        wsLeads['!cols'] = fitCols(leadColumns);
        XLSX.utils.book_append_sheet(wb, wsCustomers, 'Customers (filtered)');
        XLSX.utils.book_append_sheet(wb, wsLeads, 'Leads (filtered)');
        
        const dateStr = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
        const filename = `KCP-Export_${dateStr}_MultiFilter.xlsx`;
        XLSX.writeFile(wb, filename);
      }catch(err){ showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÄ‡∏õ‡πá‡∏ô Excel ‡πÑ‡∏î‡πâ: ' + (err.message || String(err))); }
    }

    // ==========================================
    // 7. TAB & CONTROLS BINDING
    // ==========================================
    const tabMap = document.getElementById('tabMap');
    const tabDash = document.getElementById('tabDash');
    const viewMap = document.getElementById('viewMap');
    const viewDash = document.getElementById('viewDash');

    function setTab(which){
      if(which==='map'){
        viewMap.classList.remove('hidden'); viewDash.classList.add('hidden');
        tabMap.className = "px-3 py-2 text-sm rounded-xl bg-gray-900 text-white shadow";
        tabDash.className = "px-3 py-2 text-sm rounded-xl bg-white/90 backdrop-blur border border-gray-200 text-gray-800 shadow";
        try { map?.invalidateSize?.(); } catch(e){}
      }else{
        viewDash.classList.remove('hidden'); viewMap.classList.add('hidden');
        tabDash.className = "px-3 py-2 text-sm rounded-xl bg-gray-900 text-white shadow";
        tabMap.className = "px-3 py-2 text-sm rounded-xl bg-white/90 backdrop-blur border border-gray-200 text-gray-800 shadow";
        loadDash(false);
      }
    }
    tabMap.addEventListener('click', ()=>setTab('map'));
    tabDash.addEventListener('click', ()=>setTab('dash'));

    // Controls
    document.getElementById('btnRefresh').onclick = ()=>loadAndRender(true);
    document.getElementById('btnReset').onclick = ()=>{
       activeFilters = { branch: [], manager: [], truck: [], status: [] };
       document.querySelectorAll('.ms-item input').forEach(c => c.checked = false);
       document.querySelectorAll('.ms-btn span').forEach(s => {
           s.textContent = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'; s.classList.add('text-gray-500'); s.classList.remove('text-gray-900');
       });
       document.querySelectorAll('.radiusChoice').forEach(ch=>{ ch.checked=false; });
       render();
    };
    ['toggleLeads','toggleNearest'].forEach(id => document.getElementById(id).addEventListener('change',render));
    document.querySelectorAll('.radiusChoice').forEach(el=>{ el.addEventListener('change', render); });
    document.getElementById('btnExport').onclick = exportFilteredToExcel;

    // Start App
    loadAndRender();
    setInterval(loadAndRender,300000);

    // ==========================================
    // 8. DASHBOARD LOGIC (ORIGINAL PRESERVED)
    // ==========================================
    const crmOwnerFilter = document.getElementById('crmOwnerFilter');
    const crmBranchFilter = document.getElementById('crmBranchFilter');
    const dashStartDate = document.getElementById('dashStartDate');
    const dashEndDate = document.getElementById('dashEndDate');
    const btnDashRefresh = document.getElementById('btnDashRefresh');

    const kpiTaskTotal = document.getElementById('kpiTaskTotal');
    const kpiTaskFollow = document.getElementById('kpiTaskFollow');
    const kpiTaskRate = document.getElementById('kpiTaskRate');
    const kpiTaskDone = document.getElementById('kpiTaskDone');
    const kpiLeadTotal = document.getElementById('kpiLeadTotal');
    const kpiLeadFollow = document.getElementById('kpiLeadFollow');
    const kpiLeadRate = document.getElementById('kpiLeadRate');
    const kpiLeadWon = document.getElementById('kpiLeadWon');
    const truckTableBody = document.getElementById('truckTableBody');

    const CRM_COLS = {
      id: "Unique_ID", customer: "‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤", type: "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤", due: "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥",
      owner: "‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö", done: "‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏ö/‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß?", workStatus: "‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô",
      nextFollow: "üóìÔ∏è ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ï‡πà‡∏≠", note: "‡πÇ‡∏ô‡πâ‡∏ï‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠/‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏ö",
      bu: "BU", pipeline: "Pipeline", saleChannel: "‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢", contactChannel: "‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠",
    };

    function isLeadRow(r){ return norm(r[CRM_COLS.type]).toLowerCase().includes('lead') || norm(r[CRM_COLS.type]).includes('‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏°‡∏∏‡πà‡∏á‡∏´‡∏ß‡∏±‡∏á'); }
    function isDoneRow(r){
      const d = String(r[CRM_COLS.done]).toUpperCase().trim();
      const ws = norm(r[CRM_COLS.workStatus]);
      return d === "TRUE" || ws === "‡πÄ‡∏™‡∏£‡πá‡∏à" || ws === "‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
    }
    function pct(a,b){ return (b ? (a/b*100) : 0).toFixed(2) + "%"; }
    function parseDateFlexible(v){
      const s = norm(v);
      if(!s) return null;
      if(v instanceof Date) return isNaN(v.getTime())?null:v;
      const m1 = s.match(/^(\d{4})-(\d{2})-(\d{2})/);
      if(m1) return isNaN(new Date(Number(m1[1]), Number(m1[2])-1, Number(m1[3])).getTime())?null:new Date(Number(m1[1]), Number(m1[2])-1, Number(m1[3]));
      const m2 = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})/);
      if(m2) return isNaN(new Date(Number(m2[3]), Number(m2[1])-1, Number(m2[2])).getTime())?null:new Date(Number(m2[3]), Number(m2[1])-1, Number(m2[2]));
      const d = new Date(s);
      return isNaN(d.getTime())?null:d;
    }
    function getDashDateRange(){
      const s = dashStartDate?.value ? new Date(dashStartDate.value) : null;
      const e = dashEndDate?.value ? new Date(dashEndDate.value) : null;
      if(e) e.setHours(23,59,59,999);
      return { start:s, end:e };
    }
    function inRange(d, start, end){
      if(!d) return false;
      if(start && d < start) return false;
      if(end && d > end) return false;
      return true;
    }
    function destroyChart(c){ try{ c?.destroy?.(); }catch(e){} }
    function makeDoughnut(canvasId, labels, values){
      const ctx = document.getElementById(canvasId);
      return new Chart(ctx, {
        type: 'doughnut', data: { labels, datasets: [{ data: values }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 10, usePointStyle: true } }, tooltip: { callbacks: { label: (c)=> `${c.label}: ${c.raw}` } } }, cutout: '60%' }
      });
    }
    function makeBar(canvasId, labels, values){
      const ctx = document.getElementById(canvasId);
      return new Chart(ctx, {
        type: 'bar', data: { labels, datasets: [{ data: values }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display:false } }, scales: { x: { ticks: { autoSkip:false } }, y: { beginAtZero:true } } }
      });
    }
    function groupCount(rows, keyFn){
      const m = new Map();
      rows.forEach(r=>{ const k = norm(keyFn(r)); if(!k) return; m.set(k, (m.get(k)||0)+1); });
      return [...m.entries()].sort((a,b)=>b[1]-a[1]);
    }
    function topNwithOther(arr, n=8){
       if(arr.length<=n) return arr;
       const top = arr.slice(0,n);
       const other = arr.slice(n).reduce((s,[_k,v])=>s+v,0);
       top.push(["‡∏≠‡∏∑‡πà‡∏ô‡πÜ", other]);
       return top;
    }

    async function loadDash(skipInit){
      try{
        if(!skipInit) btnDashRefresh.textContent = "Loading...";
        const dataset = await fetchSheet(CRM_SHEETS.dataset, CRM_SHEET_ID);
        const leadsAll = (typeof data !== 'undefined' && data.leads) ? data.leads : [];

        if(!skipInit){
          crmOwnerFilter.innerHTML = "";
          crmOwnerFilter.append(new Option("‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î",""));
          ALLOWED_SALES_NAMES.forEach(o=>crmOwnerFilter.append(new Option(o,o)));
          crmOwnerFilter.append(new Option("‡∏≠‡∏∑‡πà‡∏ô‡πÜ","‡∏≠‡∏∑‡πà‡∏ô‡πÜ"));
          const branches = uniqueSorted(dataset.map(r=>norm(r[CRM_COLS.bu])).filter(Boolean));
          crmBranchFilter.innerHTML = "";
          crmBranchFilter.append(new Option("‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤",""));
          branches.forEach(b => crmBranchFilter.append(new Option(b, b)));
        }

        const ownerSel = crmOwnerFilter.value;
        let rows = dataset;
        if(ownerSel) { rows = rows.filter(r => getOwnerGroup(r[CRM_COLS.owner]) === ownerSel); }
        const branchSel = crmBranchFilter.value;
        if(branchSel){ rows = rows.filter(r => norm(r[CRM_COLS.bu]) === branchSel); }
        const dr = getDashDateRange();
        if(dr.start || dr.end){
          rows = rows.filter(r=>{ const d = parseDateFlexible(r[CRM_COLS.due]); return inRange(d, dr.start, dr.end); });
        }

        const tasks = rows.filter(r=>!isLeadRow(r));
        const leads = rows.filter(r=>isLeadRow(r));

        // KPI
        const taskCustomers = new Set(tasks.map(r=>norm(r[CRM_COLS.customer])).filter(Boolean));
        const taskDoneCustomers = new Set(tasks.filter(isDoneRow).map(r=>norm(r[CRM_COLS.customer])).filter(Boolean));
        const taskDone = taskDoneCustomers.size;
        const taskTotal = taskCustomers.size;
        
        const leadCustomers = new Set(leads.map(r=>norm(r[CRM_COLS.customer])).filter(Boolean));
        const leadWonCustomers = new Set(leads.filter(isDoneRow).map(r=>norm(r[CRM_COLS.customer])).filter(Boolean));
        const leadWon = leadWonCustomers.size;
        const leadTotal = leadCustomers.size;

        kpiTaskTotal.textContent = taskTotal.toLocaleString();
        kpiTaskDone.textContent = taskDone.toLocaleString();
        kpiTaskFollow.textContent = Math.max(0, taskTotal - taskDone).toLocaleString();
        kpiTaskRate.textContent = pct(taskDone, taskTotal);
        kpiLeadTotal.textContent = leadTotal.toLocaleString();
        kpiLeadWon.textContent = leadWon.toLocaleString();
        kpiLeadFollow.textContent = Math.max(0, leadTotal - leadWon).toLocaleString();
        kpiLeadRate.textContent = pct(leadWon, leadTotal);

        // Charts
        const ts = topNwithOther(groupCount(tasks, r=>r[CRM_COLS.workStatus]), 8);
        const ls = topNwithOther(groupCount(leads, r=>r[CRM_COLS.workStatus]), 8);
        destroyChart(chartTaskStatus);
        chartTaskStatus = makeDoughnut('chartTaskStatus', ts.map(x=>x[0]||'(‡∏ß‡πà‡∏≤‡∏á)'), ts.map(x=>x[1]));
        destroyChart(chartLeadStatus);
        chartLeadStatus = makeDoughnut('chartLeadStatus', ls.map(x=>x[0]||'(‡∏ß‡πà‡∏≤‡∏á)'), ls.map(x=>x[1]));

        const tc = topNwithOther(groupCount(tasks, r=>r[CRM_COLS.contactChannel]), 10);
        destroyChart(chartTaskContact);
        chartTaskContact = new Chart(document.getElementById('chartTaskContact'), {
          type:'bar', data:{ labels: tc.map(x=>x[0]||'(‡∏ß‡πà‡∏≤‡∏á)'), datasets:[{ data: tc.map(x=>x[1]) }] },
          options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false}}, scales:{ x:{ ticks:{ autoSkip:false, maxRotation:40, minRotation:0 } }, y:{ beginAtZero:true } } }
        });
        const sc = topNwithOther(groupCount(tasks, r=>r[CRM_COLS.saleChannel]), 10);
        destroyChart(chartTaskChannel);
        chartTaskChannel = new Chart(document.getElementById('chartTaskChannel'), {
          type:'bar', data:{ labels: sc.map(x=>x[0]||'(‡∏ß‡πà‡∏≤‡∏á)'), datasets:[{ data: sc.map(x=>x[1]) }] },
          options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{display:false}}, scales:{ x:{ ticks:{ autoSkip:false, maxRotation:40, minRotation:0 } }, y:{ beginAtZero:true } } }
        });

        // Customers Visuals
        let customersForDash = (typeof data!=='undefined' && data && Array.isArray(data.customers)) ? data.customers : [];
        if (branchSel) { customersForDash = customersForDash.filter(c => norm(c.branch) === branchSel); }
        if (ownerSel) { customersForDash = customersForDash.filter(c => getOwnerGroup(c.person_incharge) === ownerSel); }

        renderCustomerVisuals(customersForDash);
        renderTruckSummary(customersForDash);
        renderTruckEfficiencyChart(customersForDash);
        renderActualFieldPerformance(leadsAll);
      } catch(err) { showError("Dashboard error: " + (err.message||String(err))); }
      finally { if(!skipInit) btnDashRefresh.textContent = "‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä"; }
    }

    function renderCustomerVisuals(customers){
      const counts = { "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ Active":0, "‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏´‡∏≤‡∏¢":0, "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏´‡∏≤‡∏¢":0, "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤/‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà":0, "‡∏´‡∏≤‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô 60 ‡∏ß‡∏±‡∏ô":0, "‡∏≠‡∏∑‡πà‡∏ô‡πÜ":0 };
      customers.forEach(c=>{ const st = norm(c._statusTH); if(counts[st]!=null) counts[st]++; else counts["‡∏≠‡∏∑‡πà‡∏ô‡πÜ"]++; });
      destroyChart(chartCustomerStatus);
      chartCustomerStatus = makeDoughnut('chartCustomerStatus', Object.keys(counts), Object.values(counts));

      const m = new Map();
      customers.forEach(c=>{
        const truck = norm(c.truck_id); if(!truck) return;
        const st = norm(c._statusTH);
        if(st==="‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏´‡∏≤‡∏¢" || st==="‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏´‡∏≤‡∏¢") m.set(truck, (m.get(truck)||0)+1);
      });
      const arr = [...m.entries()].sort((a,b)=>b[1]-a[1]).slice(0,10);
      destroyChart(chartTruckRisk);
      chartTruckRisk = makeBar('chartTruckRisk', arr.map(x=>x[0]), arr.map(x=>x[1]));
    }

    function renderTruckSummary(customers){
      const byTruck = {};
      const trucksAll = (typeof data!=='undefined' && data && Array.isArray(data.trucks)) ? data.trucks : [];
      trucksAll.forEach(t=>{
        const truck = norm(t.truck_id); if(!truck) return;
        if(!byTruck[truck]){ byTruck[truck] = { truck, total:0, active:0, risky:0, lost:0, winback:0, dormant:0, owners:{} }; 
          const ownerGroup = getOwnerGroup(t.person_incharge);
          if(ownerGroup) byTruck[truck].owners[ownerGroup] = (byTruck[truck].owners[ownerGroup]||0)+1; 
        }
      });
      customers.forEach(c=>{
        const truck = norm(c.truck_id); if(!truck) return;
        if(!byTruck[truck]){ byTruck[truck] = { truck, total:0, active:0, risky:0, lost:0, winback:0, dormant:0, owners:{} }; }
        const g = byTruck[truck];
        g.total++;
        const ownerGroup = getOwnerGroup(c.person_incharge);
        if(ownerGroup) g.owners[ownerGroup] = (g.owners[ownerGroup]||0)+1;
        const st = norm(c._statusTH);
        if(st==="‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ Active") g.active++; else if(st==="‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏´‡∏≤‡∏¢") g.risky++; else if(st==="‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏´‡∏≤‡∏¢") g.lost++; else if(st==="‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤/‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà") g.winback++; else if(st==="‡∏´‡∏≤‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô 60 ‡∏ß‡∏±‡∏ô") g.dormant++;
      });
      const rows = Object.values(byTruck).filter(r => r.total > 0).sort((a,b)=>a.truck.localeCompare(b.truck,'en'));
      truckTableBody.innerHTML = rows.map(r=>{
        const topOwners = Object.entries(r.owners).sort((a,b)=>b[1]-a[1]).slice(0,3).map(([n,c])=>`${n}`).join(", ");
        return `<tr class="border-t hover:bg-gray-50 transition-colors"><td class="p-2 font-semibold text-gray-900">${r.truck}</td><td class="p-2 text-gray-600">${topOwners || "-"}</td><td class="p-2 text-right font-bold text-gray-900">${r.total}</td><td class="p-2 text-right text-emerald-600 font-medium">${r.active}</td><td class="p-2 text-right text-amber-500">${r.risky}</td><td class="p-2 text-right text-red-500">${r.lost}</td><td class="p-2 text-right text-blue-500">${r.winback}</td><td class="p-2 text-right text-gray-400">${r.dormant}</td></tr>`;
      }).join("");
      if(rows.length === 0) { truckTableBody.innerHTML = `<tr><td colspan="8" class="p-4 text-center text-gray-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</td></tr>`; }
    }

    function renderTruckEfficiencyChart(customers) {
      const trucks = {};
      customers.forEach(c => {
        const tid = norm(c.truck_id); if (!tid) return;
        if (!trucks[tid]) { trucks[tid] = { id: tid, total: 0, counts: { 'ACTIVE': 0, 'WINBACK': 0, 'RISKY': 0, 'LOST': 0, 'DORMANT': 0 } }; }
        trucks[tid].total++;
        const st = norm(c._statusTH);
        if (st === "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ Active") trucks[tid].counts.ACTIVE++; else if (st === "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤/‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà") trucks[tid].counts.WINBACK++; else if (st === "‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏´‡∏≤‡∏¢") trucks[tid].counts.RISKY++; else if (st === "‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏´‡∏≤‡∏¢") trucks[tid].counts.LOST++; else if (st === "‡∏´‡∏≤‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô 60 ‡∏ß‡∏±‡∏ô") trucks[tid].counts.DORMANT++; else trucks[tid].counts.LOST++;
      });
      let truckArray = Object.values(trucks).map(t => ({ ...t, activeRate: t.total > 0 ? (t.counts.ACTIVE / t.total) * 100 : 0 }));
      truckArray.sort((a, b) => b.activeRate - a.activeRate);
      const labels = truckArray.map(t => t.id);
      const makeDataset = (label, color, key) => ({ label, data: truckArray.map(t => t.total > 0 ? (t.counts[key] / t.total * 100) : 0), backgroundColor: color, stack: 'Stack 0', rawCounts: truckArray.map(t => t.counts[key]) });
      destroyChart(chartTruckEfficiency); 
      chartTruckEfficiency = new Chart(document.getElementById('chartTruckEfficiency').getContext('2d'), {
        type: 'bar', data: { labels, datasets: [ makeDataset('‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ Active', '#10b981', 'ACTIVE'), makeDataset('Winback/New', '#3b82f6', 'WINBACK'), makeDataset('‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á (Risky)', '#f59e0b', 'RISKY'), makeDataset('‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏´‡∏≤‡∏¢ (Lost)', '#ef4444', 'LOST'), makeDataset('Dormant >60', '#6b7280', 'DORMANT') ] },
        options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { tooltip: { callbacks: { label: function(context) { const val = context.raw.toFixed(1); const count = context.dataset.rawCounts[context.dataIndex]; return `${context.dataset.label}: ${count} ‡∏£‡∏≤‡∏¢ (${val}%)`; } } }, legend: { position: 'top' } }, scales: { x: { stacked: true, max: 100, title: { display: true, text: '‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (%)' } }, y: { stacked: true, grid: { display: false } } } }
      });
    }

    function renderActualFieldPerformance(allLeads) {
      const ownerSel = crmOwnerFilter.value;
      const { start, end } = getDashDateRange();
      const getLeadDate = (r) => parseDateFlexible(r.date); 
      const isClosed = (r) => { const s = norm(r.status).toLowerCase(); return s === '‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢' || s === 'closed'; };
      const leadsInTime = allLeads.filter(r => { const d = getLeadDate(r); return inRange(d, start, end); });

      const visitCounts = {};
      leadsInTime.forEach(r => { 
          let groupName = getOwnerGroup(r.saller); 
          visitCounts[groupName] = (visitCounts[groupName] || 0) + 1; 
      });
      const sortedVisits = Object.entries(visitCounts).sort((a,b) => b[1] - a[1]);
      destroyChart(chartActualVisits);
      chartActualVisits = new Chart(document.getElementById('chartActualVisits'), {
          type: 'bar', data: { labels: sortedVisits.map(x => x[0]), datasets: [{ label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏û‡∏ö (‡∏£‡∏≤‡∏¢)', data: sortedVisits.map(x => x[1]), backgroundColor: '#0f172a', borderRadius: 4 }] },
          options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', scales: { x: { beginAtZero: true } }, plugins: { legend: { display: false } } }
      });

      let filteredLeadsRange = leadsInTime;
      if(ownerSel) filteredLeadsRange = filteredLeadsRange.filter(r => getOwnerGroup(r.saller) === ownerSel);
      const countVisit = filteredLeadsRange.length;
      const countClosedRange = filteredLeadsRange.filter(isClosed).length;
      const convRate = countVisit > 0 ? ((countClosedRange/countVisit)*100).toFixed(1) + '%' : '0%';
      document.getElementById('actVisitCount').textContent = countVisit.toLocaleString();
      document.getElementById('actSaleRange').textContent = countClosedRange.toLocaleString();
      document.getElementById('actConvRange').textContent = convRate;

      let filteredLeadsAcc = allLeads;
      if(ownerSel) filteredLeadsAcc = filteredLeadsAcc.filter(r => getOwnerGroup(r.saller) === ownerSel);
      const countClosedAcc = filteredLeadsAcc.filter(isClosed).length;
      document.getElementById('actSaleAcc').textContent = countClosedAcc.toLocaleString();

      destroyChart(chartActualSales);
      chartActualSales = new Chart(document.getElementById('chartActualSales').getContext('2d'), {
          type: 'bar', data: { labels: ['‡∏™‡∏∞‡∏™‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (All Time)', '‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (Selected)'], datasets: [{ label: '‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢ (‡∏£‡∏≤‡∏¢)', data: [countClosedAcc, countClosedRange], backgroundColor: ['#2563eb', '#059669'], barPercentage: 0.6 }] },
          options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, title: { display: true, text: `‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏Å‡∏≤‡∏£‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢: ${ownerSel || "‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô"}` } }, scales: { y: { beginAtZero: true, ticks: { precision: 0 } } } }
      });
    }
    
    // Bind Events for Dashboard
    btnDashRefresh.addEventListener('click', ()=>loadDash(true));
    crmOwnerFilter.addEventListener('change', ()=>loadDash(true));
    crmBranchFilter.addEventListener('change', ()=>loadDash(true));
    dashStartDate?.addEventListener('change', ()=>loadDash(true));
    dashEndDate?.addEventListener('change', ()=>loadDash(true));

</script>





  
</body>
</html>
